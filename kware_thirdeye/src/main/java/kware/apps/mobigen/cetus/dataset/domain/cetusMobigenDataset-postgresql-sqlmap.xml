<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cetusMobigenDataset">

    <select id="getAllMobigenDatasetList" resultType="MobigenDatasetList" parameterType="SearchMobigenDataset">
        /* cetusMobigenDataset.getAllMobigenDatasetList */
        SELECT CMD.UID
              ,CMD.TITLE
              ,COALESCE(CU.USER_ID, '자동 저장') AS REGISTRANT_ID
              ,TO_CHAR(CMD.REG_DT, 'YYYY-MM-DD HH:MM') AS REG_DT
          FROM CETUS_MOBIGEN_DATASET CMD
          LEFT JOIN CETUS_MOBIGEN_REGISTRANT CMR ON CMR.DATASET_ID = CMD.UID
          LEFT JOIN CETUS_USER CU ON CU.UID = CMR.REGISTRANT_UID
         WHERE 1 = 1
           AND CMD.DELETE_AT = 'N'
        <if test="@Ognl@isNotEmpty(registrantId)">
           AND CU.USER_ID LIKE '%' || #{registrantId} || '%'
        </if>
         ORDER BY CMD.REG_DT DESC
    </select>

    <select id="getAllMobigenDatasetPage" resultType="MobigenDatasetList" parameterType="SearchMobigenDataset">
        /* cetusMobigenDataset.getAllMobigenDatasetPage */
        SELECT CMD.UID
              ,CMD.TITLE
              ,COALESCE(CU.USER_ID, '자동 저장') AS REGISTRANT_ID
              ,TO_CHAR(CMD.REG_DT, 'YYYY-MM-DD HH:MM') AS REG_DT
          FROM CETUS_MOBIGEN_DATASET CMD
          LEFT JOIN CETUS_MOBIGEN_REGISTRANT CMR ON CMR.DATASET_ID = CMD.UID
          LEFT JOIN CETUS_USER CU ON CU.UID = CMR.REGISTRANT_UID
         WHERE 1 = 1
           AND CMD.DELETE_AT = 'N'
        <if test="@Ognl@isNotEmpty(registrantId)">
           AND CU.USER_ID LIKE '%' || #{registrantId} || '%'
        </if>
        <if test="@Ognl@isNotEmpty(approvedIds)">
           AND CMD.UID NOT IN <foreach collection="approvedIds" item="id" open="(" separator="," close=")">#{id}</foreach>
        </if>
         ORDER BY CMD.REG_DT DESC
        <if test="@Ognl@isNotEmpty(startNumber) and  @Ognl@isNotEmpty(endNumber)">
        OFFSET ${startNumber} LIMIT ${endNumber}
        </if>
    </select>

    <select id="getAllMobigenDatasetPageCount" resultType="int" parameterType="SearchMobigenDataset">
        /* cetusMobigenDataset.getAllMobigenDatasetPageCount */
        SELECT COUNT(*)
          FROM CETUS_MOBIGEN_DATASET CMD
          LEFT JOIN CETUS_MOBIGEN_REGISTRANT CMR ON CMR.DATASET_ID = CMD.UID
          LEFT JOIN CETUS_USER CU ON CU.UID = CMR.REGISTRANT_UID
         WHERE 1 = 1
           AND CMD.DELETE_AT = 'N'
        <if test="@Ognl@isNotEmpty(registrantId)">
           AND CU.USER_ID LIKE '%' || #{registrantId} || '%'
        </if>
        <if test="@Ognl@isNotEmpty(approvedIds)">
           AND CMD.UID NOT IN <foreach collection="approvedIds" item="id" open="(" separator="," close=")">#{id}</foreach>
        </if>
    </select>

    <insert id="insert" parameterType="CetusMobigenDataset" useGeneratedKeys="true" keyProperty="uid">
        /* cetusMobigenDataset.insert */
        INSERT INTO CETUS_MOBIGEN_DATASET (
             TITLE
            ,METADATA_FILE_UID
            ,REALDATA_FILE_UID
            ,REG_DT
            ,DELETE_AT
            ,METADATA
        ) VALUES (
             #{title}
            ,#{metadataFileUid}::int8
            ,#{realdataFileUid}::int8
            ,NOW()
            ,'N'
            ,#{metadata}::jsonb
        )
    </insert>

    <update id="deleteMobigenDataset" parameterType="CetusMobigenDataset">
        /* cetusMobigenDataset.deleteMobigenDataset */
        UPDATE CETUS_MOBIGEN_DATASET
           SET DELETE_AT = 'Y'
         WHERE UID = #{uid}
    </update>

    <select id="getMobigenDatasetByDatasetId" parameterType="Long" resultType="MobigenDatasetView">
        /* cetusMobigenDataset.getMobigenDatasetByDatasetId */
        SELECT CMD.UID
              ,CMD.TITLE
              ,CU.USER_ID AS REGISTRANT_ID
              ,TO_CHAR(CMD.REG_DT, 'YYYY-MM-DD HH:MM') AS REG_DT
              ,CMD.METADATA_FILE_UID
              ,CMD.REALDATA_FILE_UID
              ,CMD.METADATA
          FROM CETUS_MOBIGEN_DATASET CMD
          LEFT JOIN CETUS_MOBIGEN_REGISTRANT CMR ON CMR.DATASET_ID = CMD.UID
          LEFT JOIN CETUS_USER CU ON CU.UID = CMR.REGISTRANT_UID
         WHERE CMD.UID = #{uid}
    </select>

    <update id="update" parameterType="CetusMobigenDataset">
        /* cetusMobigenDataset.update */
        UPDATE CETUS_MOBIGEN_DATASET
           SET TITLE = #{title}
              ,REALDATA_FILE_UID = #{realdataFileUid}::int8
              ,METADATA = #{metadata}::jsonb
         WHERE UID = #{uid}
    </update>
</mapper>