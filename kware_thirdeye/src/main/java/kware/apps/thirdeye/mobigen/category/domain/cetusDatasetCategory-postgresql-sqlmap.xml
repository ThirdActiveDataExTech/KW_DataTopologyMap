<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cetusDatasetCategory">

    <select id="getDatasetCategoryList" parameterType="SearchCategory" resultType="CategoryList">
        /* cetusDatasetCategory.getDatasetCategoryList */
        SELECT MIN(CDC.UID) AS CATEGORY_UID
              ,CDC.CATEGORY_NM AS CATEGORY_NM
          FROM CETUS_DATASET_CATEGORY CDC
         WHERE CDC.WORKPLACE_UID = #{workplaceUid}
        <if test="@Ognl@isNotEmpty(categoryNm)">
           AND CDC.CATEGORY_NM LIKE '%' || #{categoryNm} || '%'
        </if>
         GROUP BY CDC.CATEGORY_NM
         ORDER BY CDC.CATEGORY_NM ASC
    </select>

    <insert id="insert" parameterType="CetusDatasetCategory" useGeneratedKeys="true" keyProperty="uid">
        /* cetusDatasetCategory.insert */
        INSERT INTO CETUS_DATASET_CATEGORY (
             WORKPLACE_UID
            ,CATEGORY_NM
            ,REG_UID
            ,REG_DT
            ,UPDT_UID
            ,UPDT_DT
        ) VALUES (
             #{workplaceUid}
            ,#{categoryNm}
            ,#{regUid}
            ,NOW()
            ,#{updtUid}
            ,NOW()
        )
    </insert>

    <select id="getDatasetCategoryUsingList" parameterType="SearchUsingCategory" resultType="CategoryList">
        /* cetusDatasetCategory.getDatasetCategoryUsingList */
        SELECT CDC.UID AS CATEGORY_UID
              ,CDC.CATEGORY_NM AS CATEGORY_NM
          FROM CETUS_DATASET_CATEGORY CDC
         WHERE CDC.WORKPLACE_UID = #{workplaceUid}
           AND EXISTS (
             SELECT 1
               FROM CETUS_APPROVED_DATASET CAD
                LEFT JOIN CETUS_DATASET_UI CDU ON CDU.APPROVED_DATASET_UID = CAD.UID
               WHERE CDU.CATEGORY_UID = CDC.UID
                 AND CDU.MAIN_UI_UID = #{mainUiUid}
                 AND CAD.WORKPLACE_UID = #{workplaceUid}
                 AND CAD.DELETE_AT = 'N'
                 AND CDU.SHOW_AT = 'Y'
         )
         ORDER BY CDC.CATEGORY_NM DESC
         LIMIT #{limit}
    </select>
</mapper>