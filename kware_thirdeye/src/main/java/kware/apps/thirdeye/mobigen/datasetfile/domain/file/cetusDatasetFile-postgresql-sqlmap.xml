<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cetusDatasetFile">

    <select id="key" resultType="Long" flushCache="true">
        /* cetusDatasetFile.key */
        SELECT NEXTVAL('k_thirdeye.cetus_dataset_file_file_uid_seq')
    </select>

    <select id="getFileInfoByFileId" parameterType="String" resultType="CetusDatasetFile">
        /* cetusDatasetFile.getFileInfoByFileId */
        SELECT FILE_UID
              ,FILE_ID
              ,FILE_PATH
              ,ORG_FILE_NM
              ,METADATA_ID
              ,RAWDATA_ID
          FROM CETUS_DATASET_FILE
         WHERE FILE_ID = #{fileId}
    </select>

    <update id="increaseDownCnt" parameterType="CetusDatasetFile">
        /* cetusDatasetFile.increaseDownCnt */
        UPDATE CETUS_DATASET_FILE
           SET DOWN_CNT = DOWN_CNT + 1
         WHERE FILE_ID = #{fileId}
           AND FILE_UID = #{fileUid}
    </update>

    <select id="getFileList" resultType="CetusDatasetFileList" parameterType="CetusDatasetFile">
        /* cetusDatasetFile.getFileList */
        SELECT FILE_UID
              ,FILE_ID
              ,FILE_NM
              ,ORG_FILE_NM
              ,FILE_PATH
              ,FILE_URL
              ,FILE_SIZE
              ,FILE_TYPE
              ,EXTENSION
              ,DOWN_CNT
              ,USE_AT
              ,REG_DT
              ,UPDT_DT
              ,SAVED
              ,REG_ID
              ,METADATA_ID
              ,RAWDATA_ID
              ,DATA_TP_CD
          FROM CETUS_DATASET_FILE
         WHERE FILE_UID = #{fileUid}
           AND SAVED = 'Y'
           AND USE_AT = 'Y'
         ORDER BY REG_DT DESC
    </select>

    <select id="getDataFile" resultType="CetusDatasetFileView" parameterType="SearchDatasetFile">
        /* cetusDatasetFile.getDataFile */
        SELECT FILE_UID
              ,FILE_ID
              ,FILE_NM
              ,ORG_FILE_NM
              ,FILE_PATH
              ,FILE_URL
              ,FILE_SIZE
              ,FILE_TYPE
              ,EXTENSION
              ,DOWN_CNT
              ,USE_AT
              ,REG_DT
              ,UPDT_DT
              ,SAVED
              ,REG_ID
              ,METADATA_ID
              ,RAWDATA_ID
              ,DATA_TP_CD
          FROM CETUS_DATASET_FILE
         WHERE METADATA_ID = #{metadataId}
        <if test="@Ognl@isNotEmpty(rawdataId)">
           AND RAWDATA_ID = #{rawdataId}
        </if>
           AND DATA_TP_CD = #{dataTpCd}
           AND SAVED = 'Y'
           AND USE_AT = 'Y'
    </select>

    <select id="getDataFilePage" resultType="RawdataListItemResponse" parameterType="SearchDatasetFilePage">
        /* cetusDatasetFile.getDataFilePage */
        SELECT FILE_UID
              ,FILE_ID
              ,FILE_NM
              ,ORG_FILE_NM
              ,FILE_PATH
              ,FILE_URL
              ,FILE_SIZE
              ,FILE_TYPE
              ,EXTENSION
              ,DOWN_CNT
              ,USE_AT
              ,REG_DT
              ,UPDT_DT
              ,SAVED
              ,REG_ID
              ,METADATA_ID
              ,RAWDATA_ID
              ,DATA_TP_CD
          FROM CETUS_DATASET_FILE
         WHERE METADATA_ID = #{metadataId}
        <if test="@Ognl@isNotEmpty(rawdataId)">
           AND RAWDATA_ID = #{rawdataId}
        </if>
           AND DATA_TP_CD = #{dataTpCd}
           AND SAVED = 'Y'
           AND USE_AT = 'Y'
         ORDER BY REG_DT DESC
        OFFSET #{offset} LIMIT #{limit}
    </select>

    <select id="getDataFilePageCount" resultType="int" parameterType="SearchDatasetFilePage">
        /* cetusDatasetFile.getDataFilePageCount */
        SELECT COUNT(*)
          FROM CETUS_DATASET_FILE
         WHERE METADATA_ID = #{metadataId}
        <if test="@Ognl@isNotEmpty(rawdataId)">
           AND RAWDATA_ID = #{rawdataId}
        </if>
           AND DATA_TP_CD = #{dataTpCd}
           AND SAVED = 'Y'
           AND USE_AT = 'Y'
    </select>

    <select id="getRawdataFileView" resultType="CetusDatasetFileView" parameterType="SearchDatasetFileView">
        /* cetusDatasetFile.getRawdataFileView */
        SELECT FILE_UID
              ,FILE_ID
              ,FILE_NM
              ,ORG_FILE_NM
              ,FILE_PATH
              ,FILE_URL
              ,FILE_SIZE
              ,FILE_TYPE
              ,EXTENSION
              ,DOWN_CNT
              ,USE_AT
              ,REG_DT
              ,UPDT_DT
              ,SAVED
              ,REG_ID
              ,METADATA_ID
              ,RAWDATA_ID
              ,DATA_TP_CD
          FROM CETUS_DATASET_FILE
         WHERE METADATA_ID = #{metadataId}
           AND RAWDATA_ID = #{rawdataId}
           AND DATA_TP_CD = 'RAWDATA'
           AND SAVED = 'Y'
           AND USE_AT = 'Y'
    </select>

    <insert id="insert" parameterType="CetusDatasetFile">
        /* cetusDatasetFile.insert */
        INSERT INTO CETUS_DATASET_FILE (
             FILE_ID
            ,ORG_FILE_NM
            ,FILE_PATH
            ,FILE_URL
            ,FILE_SIZE
            ,FILE_TYPE
            ,EXTENSION
            ,REG_DT
            ,UPDT_DT
            ,SAVED
            ,REG_ID
            ,METADATA_ID
            ,RAWDATA_ID
            ,DATA_TP_CD
        ) VALUES (
             #{fileId}
            ,#{orgFileNm}
            ,#{filePath}
            ,#{fileUrl}
            ,#{fileSize}
            ,#{fileType}
            ,#{extension}
            ,NOW()
            ,NOW()
            ,#{saved}
            ,#{regId}
            ,#{metadataId}
            ,#{rawdataId}
            ,#{dataTpCd}
        )
    </insert>

    <delete id="deleteDatasetFile" parameterType="DeleteDatasetFile">
        /* cetusDatasetFile.deleteDatasetFile */
        UPDATE CETUS_DATASET_FILE
           SET USE_AT = 'N'
              ,UPDT_DT = NOW()
         WHERE DATA_TP_CD = #{dataTpCd}
        <if test="@Ognl@isNotEmpty(metadataId)">
           AND METADATA_ID = #{metadataId}
        </if>
        <if test="@Ognl@isNotEmpty(rawdataId)">
           AND RAWDATA_ID = #{rawdataId}
        </if>
    </delete>

    <select id="getMetadataFilePage" parameterType="SearchFilePage" resultType="CetusDatasetFileList">
        /* cetusDatasetFile.getMetadataFilePage */
        SELECT CDF.FILE_UID
              ,CDF.FILE_ID
              ,CDF.FILE_NM
              ,CDF.ORG_FILE_NM
              ,CDF.FILE_PATH
              ,CDF.FILE_URL
              ,CDF.FILE_SIZE
              ,CDF.FILE_TYPE
              ,CDF.EXTENSION
              ,CDF.DOWN_CNT
              ,CDF.USE_AT
              ,TO_CHAR(CDF.REG_DT, 'YYYY-MM-DD HH:MM') AS REG_DT
              ,CDF.UPDT_DT
              ,CDF.SAVED
              ,CDF.REG_ID
              ,CDF.METADATA_ID
              ,CDF.RAWDATA_ID
              ,CDF.DATA_TP_CD
          FROM CETUS_DATASET_FILE CDF
         WHERE CDF.USE_AT = 'Y'
           AND CDF.SAVED = 'Y'
           AND CDF.METADATA_ID = #{metadataId}
           AND CDF.DATA_TP_CD = #{dataTpCd}
         ORDER BY CDF.REG_DT DESC
        <if test="@Ognl@isNotEmpty(startNumber) and  @Ognl@isNotEmpty(endNumber)">
        OFFSET ${startNumber} LIMIT ${endNumber}
        </if>
    </select>

    <select id="getMetadataFilePageCount" parameterType="SearchFilePage" resultType="int">
        /* cetusDatasetFile.getMetadataFilePageCount */
        SELECT COUNT(*)
          FROM CETUS_DATASET_FILE CDF
         WHERE CDF.USE_AT = 'Y'
           AND CDF.SAVED = 'Y'
           AND CDF.METADATA_ID = #{metadataId}
           AND CDF.DATA_TP_CD = #{dataTpCd}
    </select>

</mapper>