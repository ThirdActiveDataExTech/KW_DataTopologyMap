<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cetusDatasetUi">

    <select id="getCountDatasetMainUiUse" parameterType="Long" resultType="int">
        /* cetusDatasetUi.getCountDatasetMainUiUse */
        SELECT COUNT(*)
          FROM CETUS_DATASET_UI CDU
         WHERE CDU.MAIN_UI_UID = #{uid}
    </select>

    <insert id="insert" parameterType="CetusDatasetUi">
        /* cetusDatasetUi.insert */
        INSERT INTO CETUS_DATASET_UI (
             APPROVED_DATASET_UID
            ,SORT_NO
            ,MAIN_UI_UID
            ,SHOW_AT
            ,THUMB_UID
            ,CATEGORY_UID
            ,EXTRA_JSON
            ,REG_UID
            ,REG_DT
            ,UPDT_UID
            ,UPDT_DT
        ) VALUES (
             #{approvedDatasetUid}
            ,#{sortNo}
            ,#{mainUiUid}
            ,#{showAt}
            ,#{thumbUid}::int8
            ,#{categoryUid}::int8
            ,#{extraJson}::jsonb
            ,#{regUid}
            ,NOW()
            ,#{updtUid}
            ,NOW()
        )
    </insert>

    <select id="getDatasetUiView" resultType="DatasetUiView" parameterType="Long">
        /* cetusDatasetUi.getDatasetUiView */
        SELECT CDU.UID AS DATASET_UI_UID
              ,CDU.APPROVED_DATASET_UID
              ,CDU.SORT_NO
              ,CDU.MAIN_UI_UID
              ,CDU.SHOW_AT
              ,CDU.THUMB_UID
              ,CF.FILE_ID AS THUMB_ID
              ,CDU.EXTRA_JSON
          FROM CETUS_DATASET_UI CDU
          LEFT JOIN CETUS_FILE CF ON CF.FILE_UID = CDU.THUMB_UID AND CF.USE_AT = 'Y' AND CF.SAVED = 'Y'
         WHERE CDU.APPROVED_DATASET_UID = #{approvedDatasetUid}
    </select>

    <update id="update" parameterType="CetusDatasetUi">
        /* cetusDatasetUi.update */
        UPDATE CETUS_DATASET_UI
           SET SORT_NO = #{sortNo}
              ,MAIN_UI_UID = #{mainUiUid}
              ,SHOW_AT = #{showAt}
              ,THUMB_UID = #{thumbUid}::int8
              ,CATEGORY_UID = #{categoryUid}::int8
              ,EXTRA_JSON = #{extraJson}::jsonb
              ,UPDT_UID = #{updtUid}
              ,UPDT_DT = NOW()
         WHERE UID = #{uid}
    </update>

    <select id="getDatasetUiByGroup" resultType="DatasetUiGroup" parameterType="Long">
        /* cetusDatasetUi.getDatasetUiByGroup */
        SELECT CDMU.UID AS MAIN_UI_UID
              ,CDMU.CODE as MAIN_UI_CODE
              ,CDMU.TYPE_CD
              ,CDMU.MAX_COUNT
              ,CDMU.TITLE_LINE_CLAMP
              ,CDMU.DESC_LINE_CLAMP
              ,CDMU.THUMB_USE_AT
              ,COUNT(CDU.UID) AS USED_COUNT
          FROM CETUS_DATASET_MAIN_UI CDMU
          LEFT JOIN CETUS_DATASET_UI CDU ON CDU.MAIN_UI_UID = CDMU.UID
         WHERE CDMU.WORKPLACE_UID = #{workplaceUid}
           AND CDMU.DELETE_AT = 'N'
         GROUP BY CDMU.UID, CDMU.CODE, CDMU.TYPE_CD,
                  CDMU.MAX_COUNT, CDMU.TITLE_LINE_CLAMP, CDMU.DESC_LINE_CLAMP, CDMU.THUMB_USE_AT
        ORDER BY CDMU.UID;
    </select>
</mapper>