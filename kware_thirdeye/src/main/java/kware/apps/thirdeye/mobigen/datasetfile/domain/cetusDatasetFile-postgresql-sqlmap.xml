<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cetusDatasetFile">

    <select id="key" resultType="Long" flushCache="true">
        /* cetusDatasetFile.key */
        SELECT NEXTVAL('k_thirdeye.cetus_dataset_file_file_uid_seq')
    </select>

    <select id="getFileInfoByFileId" parameterType="String" resultType="CetusDatasetFile">
        /* cetusDatasetFile.getFileInfoByFileId */
        SELECT FILE_UID
              ,FILE_ID
              ,FILE_PATH
              ,ORG_FILE_NM
              ,METADATA_ID
              ,RAWDATA_ID
          FROM CETUS_DATASET_FILE
         WHERE FILE_ID = #{fileId}
    </select>

    <update id="increaseDownCnt" parameterType="CetusDatasetFile">
        /* cetusDatasetFile.increaseDownCnt */
        UPDATE CETUS_DATASET_FILE
           SET DOWN_CNT = DOWN_CNT + 1
         WHERE FILE_ID = #{fileId}
           AND FILE_UID = #{fileUid}
    </update>

    <select id="getFileList" resultType="CetusDatasetFileList" parameterType="CetusDatasetFile">
        /* cetusDatasetFile.getFileList */
        SELECT FILE_UID
              ,FILE_ID
              ,FILE_NM
              ,ORG_FILE_NM
              ,FILE_PATH
              ,FILE_URL
              ,FILE_SIZE
              ,FILE_TYPE
              ,EXTENSION
              ,DOWN_CNT
              ,USE_AT
              ,REG_DT
              ,UPDT_DT
              ,SAVED
              ,REG_ID
              ,METADATA_ID
              ,RAWDATA_ID
              ,DATA_TP_CD
          FROM CETUS_DATASET_FILE
         WHERE FILE_UID = #{fileUid}
           AND SAVED = 'Y'
           AND USE_AT = 'Y'
         ORDER BY REG_DT DESC
    </select>

    <select id="getDataFile" resultType="CetusDatasetFileView" parameterType="SearchDatasetFile">
        /* cetusDatasetFile.getDataFile */
        SELECT FILE_UID
              ,FILE_ID
              ,FILE_NM
              ,ORG_FILE_NM
              ,FILE_PATH
              ,FILE_URL
              ,FILE_SIZE
              ,FILE_TYPE
              ,EXTENSION
              ,DOWN_CNT
              ,USE_AT
              ,REG_DT
              ,UPDT_DT
              ,SAVED
              ,REG_ID
              ,METADATA_ID
              ,RAWDATA_ID
              ,DATA_TP_CD
          FROM CETUS_DATASET_FILE
         WHERE METADATA_ID = #{metadataId}
        <if test="@Ognl@isNotEmpty(rawdataId)">
           AND RAWDATA_ID = #{rawdataId}
        </if>
           AND DATA_TP_CD = #{dataTpCd}
           AND SAVED = 'Y'
           AND USE_AT = 'Y'
    </select>

    <select id="getRawdataFileView" resultType="CetusDatasetFileView" parameterType="SearchDatasetFileView">
        /* cetusDatasetFile.getRawdataFileView */
        SELECT FILE_UID
              ,FILE_ID
              ,FILE_NM
              ,ORG_FILE_NM
              ,FILE_PATH
              ,FILE_URL
              ,FILE_SIZE
              ,FILE_TYPE
              ,EXTENSION
              ,DOWN_CNT
              ,USE_AT
              ,REG_DT
              ,UPDT_DT
              ,SAVED
              ,REG_ID
              ,METADATA_ID
              ,RAWDATA_ID
              ,DATA_TP_CD
          FROM CETUS_DATASET_FILE
         WHERE METADATA_ID = #{metadataId}
           AND RAWDATA_ID = #{rawdataId}
           AND DATA_TP_CD = 'RAWDATA'
           AND SAVED = 'Y'
           AND USE_AT = 'Y'
    </select>

    <insert id="insert" parameterType="CetusDatasetFile">
        /* cetusDatasetFile.insert */
        INSERT INTO CETUS_DATASET_FILE (
             FILE_ID
            ,ORG_FILE_NM
            ,FILE_PATH
            ,FILE_URL
            ,FILE_SIZE
            ,FILE_TYPE
            ,EXTENSION
            ,REG_DT
            ,UPDT_DT
            ,SAVED
            ,REG_ID
            ,METADATA_ID
            ,RAWDATA_ID
            ,DATA_TP_CD
        ) VALUES (
             #{fileId}
            ,#{orgFileNm}
            ,#{filePath}
            ,#{fileUrl}
            ,#{fileSize}
            ,#{fileType}
            ,#{extension}
            ,NOW()
            ,NOW()
            ,#{saved}
            ,#{regId}
            ,#{metadataId}
            ,#{rawdataId}
            ,#{dataTpCd}
        )
    </insert>

    <delete id="deleteFile" parameterType="CetusDatasetFile">
        /* cetusDatasetFile.deleteFile */
        UPDATE CETUS_DATASET_FILE
           SET USE_AT = 'N'
              ,UPDT_DT = NOW()
         WHERE FILE_ID = #{fileId}
    </delete>

    <update id="updateDatasetFile" parameterType="ChangeDatasetFile">
        /* cetusDatasetFile.updateDatasetFile */
        UPDATE CETUS_DATASET_FILE
           SET UPDT_DT = NOW()
        <if test="@Ognl@isNotEmpty(metadataId)">
              ,METADATA_ID = #{metadataId}
        </if>
        <if test="@Ognl@isNotEmpty(rawdataId)">
              ,RAWDATA_ID = #{rawdataId}
        </if>
         WHERE FILE_ID = #{fileId}
    </update>

</mapper>