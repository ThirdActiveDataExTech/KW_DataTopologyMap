<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default2}">

<th:block layout:fragment="center-image">
    <th:block th:with="title1=${currentPageName}, title2=${navigation}, leftImg=${centerLeftImage}, rightImg=${centerRightImage}">
        <th:block th:replace="fragments/center-image :: main-image-title(${title1}, ${title2}, ${leftImg}, ${rightImg})"></th:block>
    </th:block>
</th:block>

<th:block layout:fragment="head">
    <link rel="stylesheet" th:href="@{'/assets/css/page/thirdeye/dataset-list.css'}"/>
    <style>
        .page-list-content .tag-content {
            cursor: pointer;
        }
        .tag-content .close-btn {
            cursor: pointer;
            margin-left: 6px;
            font-weight: bold;
        }
        .sidebar-widget .sidebar-list-style ul li:last-child {
            margin: 0 0 14px !important;
            margin-left: 0px !important;
            margin-top: 5px !important;
        }
        #sidebar-widgets-container2 .sidebar-widget .sidebar-list-style ul li:last-child {
            margin: 0 0 14px !important;
            margin-left: 5px !important;
            margin-top: 5px !important;
        }
        .select2-container .select2-search--inline .select2-search__field {
            margin-left: 10px !important;
            margin-bottom: 10px !important;
        }
    </style>
    <style>
        .button-reset {
            background: #f3f3f3;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .button-reset:hover {
            background: #e9e9e9;
        }
    </style>
</th:block>
<th:block layout:fragment="content">

    <div class="page-area page-responsive pt-80" data-aos="fade-up" data-aos-delay="200">
        <div class="container" style="margin-bottom: 200px;">
            <div class="row flex-row-reverse">

                <!-- col-lg-9 //-->
                <div class="col-lg-9">
                    <div class="page-topbar-wrapper mb-40">
                        <div class="page-topbar-left">
                            <div class="showing-item">
                                <span id="showing-card">
                                    <!-- Showing 1–12 of 60 results -->
                                </span>
                                <span id="showing-list">
                                    <!-- Showing 1–12 of 60 results -->
                                </span>
                            </div>
                        </div>
                        <div class="page-topbar-right">
                            <div class="page-view-mode nav" role="tablist">
                                <a class="active" href="#shop-1" data-bs-toggle="tab" aria-selected="true" tabindex="-1" role="tab" onclick="listJS.fnTab('card')">
                                    <i class=" ti-layout-grid3 "></i>
                                </a>
                                <a href="#shop-2" data-bs-toggle="tab" aria-selected="false" role="tab" onclick="listJS.fnTab('list')">
                                    <i class=" ti-view-list-alt "></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="page-bottom-area">
                        <div class="tab-content jump">
                            <div id="shop-1" class="tab-pane active" role="tabpanel">
                                <div class="row">
                                    <!-- card view -->
                                </div>
                                <div id="card-pagination" class="pagination-style-1">
                                    <!-- card pagination -->
                                </div>
                            </div>
                            <div id="shop-2" class="tab-pane" role="tabpanel">
                                <!-- list view -->
                                <!-- list pagination -->
                            </div>
                        </div>
                    </div>
                </div>
                <!--// col-lg-9 -->

                <!-- col-lg-3 //-->
                <div class="col-lg-3">

                    <div class="sidebar-widget mb-40 aos-init aos-animate" data-aos="fade-up" data-aos-delay="200">
                        <div class="search-wrap-2" style="display: flex; align-items: center; gap: 8px;">
                            <div style="position: relative; flex: 1;">
                                <form class="search-2-form" id="searchForm" action="#">
                                    <input id="keyword" placeholder="컨텐츠 제목을 입력하세요" type="text" style="width: 100%;">
                                    <button type="button" id="search-button" class="button-search"><i class="ti-search"></i></button>
                                </form>
                            </div>
                            <button type="button" id="resetBtn" class="button-reset">초기화</button>
                        </div>
                    </div>

                    <div class="sidebar-wrapper mb-40">
                        <div id="sidebar-widgets-container1">
                            <div class="sidebar-widget sidebar-widget-border mb-40 pb-35" data-aos="fade-up" data-aos-delay="200">
                                <div class="sidebar-widget-title mb-25">
                                    <h3>카테고리</h3>
                                </div>
                                <div id="categories" class="sidebar-widget-color sidebar-list-style"></div>
                            </div>
                        </div>
                        <div id="sidebar-widgets-container2">
                            <div class="sidebar-widget sidebar-widget-border mb-40 pb-35" data-aos="fade-up" data-aos-delay="200">
                                <div class="sidebar-widget-title mb-25">
                                    <h3>태그</h3>
                                </div>
                                <div id="tags" class="sidebar-widget-color sidebar-list-style">
                                    <select class="select2 round border_line" id="tags-select" multiple></select>
                                </div>
                            </div>
                        </div>
                        <div id="sidebar-widgets-container3">
                            <div class="sidebar-widget sidebar-widget-border mb-40 pb-35" data-aos="fade-up" data-aos-delay="600">
                                <div class="sidebar-widget-title mb-30">
                                    <h3>승인일시</h3>
                                </div>
                                <div class="page-filter">
                                    <div id="slider-range"></div>
                                    <div class="page-slider-amount">
                                        <div class="label-input">
                                            <input type="text" id="amount1" name="price" style="width: 100%; text-align: center;"/>
                                        </div>
                                        -
                                        <div class="label-input">
                                            <input type="text" id="amount2" name="price" style="width: 100%; text-align: center;"/>
                                        </div>
                                        <button type="button" id="date-btn">적용</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--// col-lg-3 -->

            </div>
        </div>
    </div>

</th:block>

<th:block layout:fragment="script">
    <script th:src="@{'/assets/js/page/thirdeye/dataset/dataset-list.js'}"></script>
    <script th:inline="javascript">
        
        $(async function () {

            // 전체 검색을 통한 리스트 화면 접근시
            const searchParams = window.location.search.substring(1);
            const params = new URLSearchParams(searchParams);
            const keyword = params.get('keyword');
            if (keyword) {
                $('#keyword').val(keyword);
                listJS.keyword = keyword;
                window.history.replaceState({}, document.title, '/portal/list');
            }

            // 2. 등록일 slider init
            listJS.dom.sliderRange.slider({
                range: true,
                min: 0,
                max: 365,
                values: [0, 365],
                slide: function (event, ui) {
                    $('#amount1').val(DateUtil.dateFormat(ui.values[0]))
                    $('#amount2').val(DateUtil.dateFormat(ui.values[1]))
                }
            });
            const _startDate = DateUtil.dateFormat(listJS.dom.sliderRange.slider("values", 0))
            const _endDate = DateUtil.dateFormat(listJS.dom.sliderRange.slider("values", 1))
            $('#amount1').val(_startDate)
            $('#amount2').val(_endDate)
            listJS.param['date'][0] = _startDate
            listJS.param['date'][1] = _endDate
            $('#amount1, #amount2').on('blur', function () {
                const val1 = new Date($('#amount1').val())
                const val2 = new Date($('#amount2').val())
                if (!isNaN(val1) && !isNaN(val2) && val1 <= val2) {
                    listJS.dom.sliderRange.slider('values', [listJS.parseDate(val1), listJS.parseDate(val2)]);
                }
            });

            // 4. 등록일 버튼 -> 검색
            $("#date-btn").click(function () {
                listJS.param['date'][0] = DateUtil.dateFormat(listJS.dom.sliderRange.slider("values", 0));
                listJS.param['date'][1] = DateUtil.dateFormat(listJS.dom.sliderRange.slider("values", 1));
                listJS.fnPage(1, false);
            });

            // 5. 검색어 검색
            $('#searchForm').on('keypress', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // 기본 동작(폼 제출) 막기
                    listJS.keyword = $('#keyword').val();
                    listJS.fnPage(1, false);
                }
            });
            $("#search-button").on('click', function (event) {
                event.preventDefault(); // 기본 동작(폼 제출) 막기
                listJS.keyword = $('#keyword').val();
                listJS.fnPage(1, false);
            });

            // 6. 검색조건 검색
            // ✅ 모든 체크박스 이벤트 (개별 + 전체선택)
            $(document).on('change', 'input[type="checkbox"]', function (e) {

                const $this = $(this);
                if ($this.attr('id') === "category_all") {

                    const checked = $this.is(":checked");               // 전체 선택 체크박스
                    $(".category-item").prop("checked", checked);       // 개별 카테고리 체크박스 상태 변경
                    $(".category-item").each(function () {
                        const type = $(this).attr('id').split('_')[0];
                        const value = $(this).val();
                        if ($(this).is(':checked')) {
                            listJS.param[type] = listJS.param[type] || [];
                            if (!listJS.param[type].includes(value)) listJS.param[type].push(value);
                        } else {
                            listJS.param[type] = listJS.param[type] || [];
                            listJS.param[type] = listJS.param[type].filter(item => item !== value);
                        }
                    });
                    listJS.fnPage(1, false);

                } else {

                    const type = $this.attr('id').split('_')[0];
                    const value = $this.val();
                    listJS.param[type] = listJS.param[type] || [];

                    if ($this.is(':checked')) {
                        if (!listJS.param[type].includes(value)) listJS.param[type].push(value);
                    } else {
                        listJS.param[type] = listJS.param[type].filter(item => item !== value);
                    }

                    const total = $(".category-item").length;
                    const checked = $(".category-item:checked").length;
                    $("#category_all").prop("checked", total === checked);

                    listJS.fnPage(1, false);
                }
            });


            // 7. 뷰 버튼 클릭
            $(document).on('click', '.detail-btn', function () {
                const uid = $(this).data('id');
                window.location.href = `/portal/detail/${uid}`;
            });

            // 8. 좋아요 버튼 클릭
            $(document).on('click', '.like-content-btn', function (e) {
                Common.likeClickEvent(this);
            });

            // 9. 태그 > select2 > 검색
            $("#tags-select").select2({
                placeholder: '태그 검색',
                language: {
                    noResults: function() {
                        return "검색 결과가 없습니다.";
                    }
                }
            });
            $('#tags-select').on('select2:select select2:unselect', function (e) {
                listJS.param['tag'] = [];
                const data = $(this).val();
                if (data && data.length) {
                    data.forEach(uid => {
                        listJS.param['tag'].push(uid);
                    });
                }
                listJS.fnPage(1, false);
            });

            $("#resetBtn").on('click', function () {
                listJS.resetAll();
            });


            // >> refresh page list
            await listJS.refreshPageList();
        });

    </script>
</th:block>
</html>