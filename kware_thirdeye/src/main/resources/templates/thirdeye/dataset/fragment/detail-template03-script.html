<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<script th:inline="javascript">

    var template03JS = {

        page: 1,
        keyword: '',
        param : { tag: [] }, // 검색 파라미터

        dom: {
            showList: $("#showing-list"),
            showCard: $("#showing-card")
        },

        drawTemplate03: function() {
            template03JS.dom.showList.hide();
            template03JS.pageList(true);
        },

        // 페이지 그리기
        pageList: async function (clearSidebar = true) {
            template03JS.pageInit();
            if (clearSidebar) template03JS.createSidebar();

            template03JS.getPageData(5).then((response) => {
                template03JS.createList(response);
            });
            template03JS.getPageData(9).then((response) => {
                template03JS.createCard(response);
            });
        },

        pageInit: function () {
            // showing text 초기화
            template03JS.dom.showCard.text("");
            template03JS.dom.showList.text("");

            // list/card 초기화
            $('#shop-2').empty();
            $('#shop-1 .row').empty();

            // pagination 초기화
            $(".pagination-style-1").empty();
        },

        createSidebar: function () {
            $("#tags-select").empty();          // 기존 내용 삭제
            Http.get('/api/portal/mobigen-tag/list').then(tags => {
                tags.forEach(item => {
                    $("#tags-select").append(`<option value="${item['tagUid']}">${item['tagNm']}</option>`)
                });
            });
        },

        getPageData: async function (size) {
            const obj = {
                pageNumber: template03JS.page,
                size: size,
                publisher: template03JS.keyword,
                theme: template03JS.param.tag
            }
            return await Http.get('/api/admin/integration-dataset/relations-page', obj);
        },

        createList: function (response) {

            const data = response['list']

            const $container = $("#shop-2")
            if( data.length !== 0 ) {

                const obj = template03JS.createPagination(response, true);

                data.forEach( content => {

                    // a. 리스트 전체 감싸는 wrap
                    const $shopListWrap = $('<div>', {
                        class: 'page-list-wrap mb-30 aos-init aos-animate',
                        'data-aos': 'fade-up',
                        'data-aos-delay': '200'
                    });

                    // b. 리스트를 묶는 row
                    const $row = $('<div>', { class: 'row' });

                    // c. 각 한개의 리스트 형태 col => 이미지 영역
                    const $col1 = $('<div>', { class: 'col-lg-4 col-sm-5' });
                    const $productListImg = $('<div>', { class: 'page-list-img' });
                    const $productLink = $('<a>', { href: 'javascript:void(0);' });
                    const randomNumber = Math.floor(Math.random() * 3) + 1;  // 1, 2, 3 중 랜덤 선택
                    const $productImage = $('<img>', {
                        src: `/assets/images/page/list/data_0${randomNumber}.jpg`,
                        alt: 'Product Style',
                        class: 'portal-img',
                    });
                    $productLink.append($productImage);
                    $productListImg.append($productLink);
                    $col1.append($productListImg);

                    // d. 제목 영역
                    const $col2 = $('<div>', { class: 'col-lg-8 col-sm-7' });
                    const $shopListContent = $('<div>', { class: 'page-list-content' });
                    $shopListContent.append(
                        $('<h3>').append(
                            $('<a>', { href: 'javascript:void(0);' }).text(content['relationMetadata']['title'])
                        )
                    );

                    /*$shopListContent.append(
                        $('<div>', { class: 'page-price' }).append(
                            $('<span>').text(content['description'])
                        )
                    );*/

                    // e. metadata 영역
                    /*const metadata = JSON.parse(content['relationMetadata']['metadata']); // JSON string → 객체
                    Object.entries(metadata).forEach(([key, value]) => {
                        $shopListContent.append(
                            $('<p>').text(`${key} : ${typeof value === 'object' ? JSON.stringify(value) : value}`)
                        );
                    });*/

                    $col2.append($shopListContent);
                    $row.append($col1, $col2);
                    $shopListWrap.append($row);
                    $container.append($shopListWrap);
                });
                $container.append(obj.pageDom);

            } else {
                $container.append('<div><p class="text-center">검색 결과가 없습니다.</p></div>');
            }
        },

        createCard: function (response) {

            const data = response['list']

            if( data.length !== 0 ) {

                const dataLength = data.length;
                const obj = template03JS.createPagination(response, false);

                data.forEach( content => {

                    // a. 카드를 감싸게 될 col
                    const $colDiv = $('<div>', { class: 'col-lg-4 col-md-4 col-sm-6 col-12' });

                    // b. 1개의 카드 요소
                    const $productWrap = $('<div>', { class: 'page-wrap mb-35' });
                    const $productImg = $('<div>', { class: 'page-img img-zoom mb-25' });
                    const $productLink = $('<a>', { href: 'javascript:void(0);' });

                    // c. 썸네일 이미지
                    const randomNumber = Math.floor(Math.random() * 3) + 1;  // 1, 2, 3 중 랜덤 선택
                    const $productImage = $('<img>', {
                        class: 'portal-img', src: `/assets/images/page/list/data_0${randomNumber}.jpg`, alt: ''
                    });
                    $productLink.append($productImage);
                    $productImg.append($productLink);

                    // d. 제목
                    const $productContent = $('<div>', { class: 'page-content' });
                    const $productTitle = $('<h3>').append($('<a>', { href: 'javascript:void(0);' }).text(content['relationMetadata']['title']));
                    /*const $productPrice = $('<div>', { class: 'page-price' }).append($('<span>').text(content['description']));*/

                    $productContent.append($productTitle/*, $productPrice*/);
                    $productWrap.append($productImg, $productContent);
                    $colDiv.append($productWrap);
                    $('#shop-1 .row').append($colDiv);
                });
                $('#shop-1 #card-pagination').html(obj.pageDom);

            } else {
                $('#shop-1 .row').append('<div><p class="text-center">검색 결과가 없습니다.</p></div>');
            }
        },

        createPagination: function (response, isList = true) {

            const totalCount = response['totalElements']
            const obj = {
                pageDom: null,
                number: response['number'],
                pageCount: response['countPage'],
                totalPages: response['totalPages'],
                startIndex: 0, endIndex: 0,
                startPage: response['startPage'],
                endPage: response['endPage']
            }
            obj.startIndex = (response['number'] - 1) * response['size'] + 1;
            obj.endIndex = obj.startIndex + response['size'] - 1;

            // 페이징 컨테이너 그리기
            const $pagination = $('<div>', {
                class: 'pagination-style-1 aos-init',
                'data-aos': 'fade-up',
                'data-aos-delay': '200'
            });

            // Create the list element
            const $ul = $('<ul>');
            for( let j = obj.startPage; j <= obj.endPage; j++ ) {
                const $li = $('<li>').append($('<a>', {
                    class: j == template03JS.page ? 'active' : '',
                    href: `javascript: template03JS.fnPage(${j});`,
                    text: j
                }));
                $ul.append($li);
            }

            // 이전페이지
            if ( obj.startPage > 1 ) {
                $ul.prepend($('<li>').append($('<a>', {
                    class: 'next',
                    href: `javascript: template03JS.fnPage(${obj.startPage - 1});`,
                }).html('<i class="ti-angle-double-left "></i>')));
            }

            // 다음페이지
            if ( obj.endPage < obj.totalPages ) {
                $ul.append($('<li>').append($('<a>', {
                    href: `javascript: template03JS.fnPage(${obj.endPage + 1});`,
                    text: '»'
                }).html('<i class="ti-angle-double-right "></i>')));
            }

            $pagination.append($ul);
            obj.pageDom = $pagination;

            if(isList) template03JS.dom.showList.text(`전체 ${totalCount}건 중 ${obj.startIndex}-${obj.endIndex > totalCount ? totalCount : obj.endIndex}`);
            else template03JS.dom.showCard.text(`전체 ${totalCount}건 중 ${obj.startIndex}-${obj.endIndex > totalCount ? totalCount : obj.endIndex}`);

            return obj;
        },

        fnPage: function(selectPage, clearSidebar) {
            template03JS.page = selectPage;
            template03JS.pageList(clearSidebar);
        },

        fnTab: function (selectTab) {
            template03JS.fnPage(1, false);
            if(selectTab === "card") { template03JS.dom.showCard.show(); template03JS.dom.showList.hide(); }
            else if(selectTab === "list") { template03JS.dom.showList.show(); template03JS.dom.showCard.hide(); }
        },
    }

    $(function () {

        // 검색어 검색
        $('#searchForm').on('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // 기본 동작(폼 제출) 막기
                template03JS.keyword = $('#keyword').val();
                template03JS.fnPage(1, false);
            }
        });

        // 검색조건 검색
        $(document).on('change', 'input[type="checkbox"]', function() {
            const type = $(this).attr('id').split('_')[0];
            const value = $(this).attr('value');
            if ($(this).is(':checked')) template03JS.param[type].push(value);
            else {
                template03JS.param[type] = template03JS.param[type].filter(item => item !== value);
            }
            template03JS.fnPage(1, false);
        });

        // 태그 > select2 > 검색
        $("#tags-select").select2({
            placeholder: '태그 검색',
            language: {
                noResults: function() {
                    return "검색 결과가 없습니다.";
                }
            }
        });
        $('#tags-select').on('select2:select select2:unselect', function (e) {
            template03JS.param['tag'] = [];
            const data = $(this).val();
            if (data && data.length) {
                data.forEach(uid => {
                    template03JS.param['tag'].push(uid);
                });
            }
            template03JS.fnPage(1, false);
        });

    });

</script>
</html>
