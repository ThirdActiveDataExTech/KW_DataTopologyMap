<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<script th:inline="javascript">

    var template03FilterJS = {

        type: null,

        initDom: function () {
            const $wrapper = $("#sidebar-wrapper-div")
            $wrapper.empty();
        },

        init(type, filter_param, values, title) {
            this.type = type;
            if(type === 'checkbox') {
                template03FilterJS.checkbox.initCheckbox(filter_param, values, title);
            } else if(type === 'select2') {
                template03FilterJS.select2.initSelect2(filter_param, values, title);
            }
        },

        checkbox: {

            initCheckbox(filter_param, values, title = '카테고리') {

                const $wrapper = $("#sidebar-wrapper-div");
                const uniqueId = 'categories-' + Date.now(); // 고유 id 생성
                const categoryContainer = $(`
                <div id="sidebar-widgets-container1">
                    <div class="sidebar-widget sidebar-widget-border mb-40 pb-35" data-aos="fade-up" data-aos-delay="400">
                        <div class="sidebar-widget-title mb-25"><h3>${title}</h3></div>
                        <div data-unique-id="${uniqueId}" class="sidebar-widget-color sidebar-list-style"></div>
                    </div>
                </div>
            `);
                $wrapper.append(categoryContainer);

                const $dom = categoryContainer.find(`div[data-unique-id="${uniqueId}"]`);
                $dom.empty();
                let $ul = $("<ul></ul>");

                // 전체 선택
                const category_ALL = 'categories-all-' + uniqueId; // 고유 id 생성
                $ul.append(`
                <li>
                    <a href="javascript:void(0);">
                        <input type="checkbox" class="category-all" value="ALL" id="${category_ALL}">
                        <label for="${category_ALL}" style="font-weight:bold;">전체 선택</label>
                    </a>
                </li>
            `);

                // 개별 선택
                for (const [key, name] of Object.entries(values)) {
                    const _category = `categories-${key}-` + uniqueId; // 고유 id 생성
                    $ul.append(`
                    <li>
                        <a href="javascript:void(0);">
                            <input type="checkbox" class="category-item" value="${key}" id="${_category}">
                            <label for="${_category}">${name}</label>
                        </a>
                    </li>
                `);
                }
                $dom.append($ul);

                // 이벤트 바인딩: container 기준으로 범위 한정
                $(document)
                    .off('change.checkbox.' + uniqueId)
                    .on('change.checkbox.' + uniqueId, `div[data-unique-id="${uniqueId}"] input[type="checkbox"]`,
                        async function() {

                            const $this = $(this);
                            const $items = $dom.find('.category-item');
                            const $all = $dom.find('.category-all');

                            if ($this.hasClass('category-all')) {
                                $items.prop('checked', $this.is(':checked'));
                            } else {
                                $all.prop('checked', $items.length === $items.filter(':checked').length);
                            }

                            template03JS.param[filter_param] = $items.filter(':checked').map((i, el) => el.value).get();
                            await template03JS.fnPage(1, false);
                        });
            },
        },

        select2: {
            initSelect2(filter_param, values, title) {

                const $wrapper = $("#sidebar-wrapper-div");
                const uniqueId = 'tags-' + Date.now();
                const tagContainer = $(`
                <div id="sidebar-widgets-container2">
                    <div class="sidebar-widget sidebar-widget-border mb-40 pb-35" data-aos="fade-up" data-aos-delay="200">
                        <div class="sidebar-widget-title mb-25"><h3>${title}</h3></div>
                        <div id="tags" class="sidebar-widget-color sidebar-list-style">
                            <select class="select2 round border_line" data-unique-id="${uniqueId}" multiple></select>
                        </div>
                    </div>
                </div>
            `);
                $wrapper.append(tagContainer);

                const $dom = tagContainer.find(`select[data-unique-id="${uniqueId}"]`);
                for (const [key, name] of Object.entries(values)) {
                    $dom.append(`<option value="${key}">${name}</option>`);
                }

                $dom.select2({ placeholder: `${title} 검색` })
                    .on('select2:select select2:unselect', async function() {
                        template03JS.param[filter_param] = $dom.val() || [];
                        await template03JS.fnPage(1, false);
                    });
            },
        },

    }


    var template03JS = {

        page: 1,
        keyword: '',
        param : { }, // 검색 파라미터

        dom: {
            showList: $("#showing-list"),
            showCard: $("#showing-card")
        },

        drawTemplate03: function() {
            template03JS.dom.showList.hide();
            template03JS.pageList(true);
        },

        // 페이지 그리기
        pageList: async function (clearSidebar = true) {
            template03JS.pageInit();
            if (clearSidebar) template03JS.createSidebar();

            template03JS.getPageData(5).then((response) => {
                template03JS.createList(response);
            });
            template03JS.getPageData(9).then((response) => {
                template03JS.createCard(response);
            });
        },

        pageInit: function () {
            // showing text 초기화
            template03JS.dom.showCard.text("");
            template03JS.dom.showList.text("");

            // list/card 초기화
            $('#shop-2').empty();
            $('#shop-1 .row').empty();

            // pagination 초기화
            $(".pagination-style-1").empty();
        },

        createSidebar: async function () {
            template03FilterJS.initDom();
            const response = await Http.get('/api/portal/integration-dataset/metakey-list')
            const filters = response['filters']
            for (const filter of filters) {
                const values = await Http.get('/api/portal/integration-dataset/metakey-value-list', { key: filter })
                if (values['filter'] === 'tag' && values['maps'] !== null) {
                    template03JS.param['tag'] = []
                    template03FilterJS.init("select2", values['filter'], values['maps'], values['filter']);
                }
            }
        },

        getPageData: async function (size) {
            const obj = {
                pageNumber: template03JS.page,
                size: size,
                publisher: template03JS.keyword,
                theme: template03JS.param.tag
            }
            return await Http.get('/api/portal/integration-dataset/relations-page', obj);
        },

        createList: function (response) {

            const data = response['list']

            const $container = $("#shop-2")
            if( data.length !== 0 ) {

                const obj = template03JS.createPagination(response, true);

                data.forEach( content => {

                    // a. 리스트 전체 감싸는 wrap
                    const $shopListWrap = $('<div>', {
                        class: 'page-list-wrap mb-30 aos-init aos-animate',
                        'data-aos': 'fade-up',
                        'data-aos-delay': '200'
                    });

                    // b. 리스트를 묶는 row
                    const $row = $('<div>', { class: 'row' });

                    // c. 각 한개의 리스트 형태 col => 이미지 영역
                    const $col1 = $('<div>', { class: 'col-lg-4 col-sm-5' });
                    const $productListImg = $('<div>', { class: 'page-list-img' });
                    const $productLink = $('<a>', { href: 'javascript:void(0);' });
                    const randomNumber = Math.floor(Math.random() * 3) + 1;  // 1, 2, 3 중 랜덤 선택
                    const $productImage = $('<img>', {
                        src: `/assets/images/page/list/data_0${randomNumber}.jpg`,
                        alt: 'Product Style',
                        class: 'portal-img',
                    });
                    $productLink.append($productImage);
                    $productListImg.append($productLink);
                    $col1.append($productListImg);

                    // d. 제목 영역
                    const $col2 = $('<div>', { class: 'col-lg-8 col-sm-7' });
                    const $shopListContent = $('<div>', { class: 'page-list-content' });
                    $shopListContent.append(
                        $('<h3>').append(
                            $('<a>', { href: 'javascript:void(0);' }).text(content['relationMetadata']['title'])
                        )
                    );

                    /*$shopListContent.append(
                        $('<div>', { class: 'page-price' }).append(
                            $('<span>').text(content['description'])
                        )
                    );*/

                    // e. extdata 영역
                    /*const extdata = JSON.parse(content['relationMetadata']['extdata']); // JSON string → 객체
                    Object.entries(extdata).forEach(([key, value]) => {
                        $shopListContent.append(
                            $('<p>').text(`${key} : ${typeof value === 'object' ? JSON.stringify(value) : value}`)
                        );
                    });*/

                    $col2.append($shopListContent);
                    $row.append($col1, $col2);
                    $shopListWrap.append($row);
                    $container.append($shopListWrap);
                });
                $container.append(obj.pageDom);

            } else {
                $container.append('<div><p class="text-center">검색 결과가 없습니다.</p></div>');
            }
        },

        createCard: function (response) {

            const data = response['list']

            if( data.length !== 0 ) {

                const dataLength = data.length;
                const obj = template03JS.createPagination(response, false);

                data.forEach( content => {

                    // a. 카드를 감싸게 될 col
                    const $colDiv = $('<div>', { class: 'col-lg-4 col-md-4 col-sm-6 col-12' });

                    // b. 1개의 카드 요소
                    const $productWrap = $('<div>', { class: 'page-wrap mb-35' });
                    const $productImg = $('<div>', { class: 'page-img img-zoom mb-25' });
                    const $productLink = $('<a>', { href: 'javascript:void(0);' });

                    // c. 썸네일 이미지
                    const randomNumber = Math.floor(Math.random() * 3) + 1;  // 1, 2, 3 중 랜덤 선택
                    const $productImage = $('<img>', {
                        class: 'portal-img', src: `/assets/images/page/list/data_0${randomNumber}.jpg`, alt: ''
                    });
                    $productLink.append($productImage);
                    $productImg.append($productLink);

                    // d. 제목
                    const $productContent = $('<div>', { class: 'page-content' });
                    const $productTitle = $('<h3>').append($('<a>', { href: 'javascript:void(0);' }).text(content['relationMetadata']['title']));
                    /*const $productPrice = $('<div>', { class: 'page-price' }).append($('<span>').text(content['description']));*/

                    $productContent.append($productTitle/*, $productPrice*/);
                    $productWrap.append($productImg, $productContent);
                    $colDiv.append($productWrap);
                    $('#shop-1 .row').append($colDiv);
                });
                $('#shop-1 #card-pagination').html(obj.pageDom);

            } else {
                $('#shop-1 .row').append('<div><p class="text-center">검색 결과가 없습니다.</p></div>');
            }
        },

        createPagination: function (response, isList = true) {

            const totalCount = response['totalElements']
            const obj = {
                pageDom: null,
                number: response['number'],
                pageCount: response['countPage'],
                totalPages: response['totalPages'],
                startIndex: 0, endIndex: 0,
                startPage: response['startPage'],
                endPage: response['endPage']
            }
            obj.startIndex = (response['number'] - 1) * response['size'] + 1;
            obj.endIndex = obj.startIndex + response['size'] - 1;

            // 페이징 컨테이너 그리기
            const $pagination = $('<div>', {
                class: 'pagination-style-1 aos-init',
                'data-aos': 'fade-up',
                'data-aos-delay': '200'
            });

            // Create the list element
            const $ul = $('<ul>');
            for( let j = obj.startPage; j <= obj.endPage; j++ ) {
                const $li = $('<li>').append($('<a>', {
                    class: j == template03JS.page ? 'active' : '',
                    href: `javascript: template03JS.fnPage(${j});`,
                    text: j
                }));
                $ul.append($li);
            }

            // 이전페이지
            if ( obj.startPage > 1 ) {
                $ul.prepend($('<li>').append($('<a>', {
                    class: 'next',
                    href: `javascript: template03JS.fnPage(${obj.startPage - 1});`,
                }).html('<i class="ti-angle-double-left "></i>')));
            }

            // 다음페이지
            if ( obj.endPage < obj.totalPages ) {
                $ul.append($('<li>').append($('<a>', {
                    href: `javascript: template03JS.fnPage(${obj.endPage + 1});`,
                    text: '»'
                }).html('<i class="ti-angle-double-right "></i>')));
            }

            $pagination.append($ul);
            obj.pageDom = $pagination;

            if(isList) template03JS.dom.showList.text(`전체 ${totalCount}건 중 ${obj.startIndex}-${obj.endIndex > totalCount ? totalCount : obj.endIndex}`);
            else template03JS.dom.showCard.text(`전체 ${totalCount}건 중 ${obj.startIndex}-${obj.endIndex > totalCount ? totalCount : obj.endIndex}`);

            return obj;
        },

        fnPage: function(selectPage, clearSidebar) {
            template03JS.getSearchData();
            template03JS.page = selectPage;
            template03JS.pageList(clearSidebar);
        },

        fnTab: function (selectTab) {
            template03JS.fnPage(1, false);
            if(selectTab === "card") { template03JS.dom.showCard.show(); template03JS.dom.showList.hide(); }
            else if(selectTab === "list") { template03JS.dom.showList.show(); template03JS.dom.showCard.hide(); }
        },

        getSearchData: function () {
            // 검색어
            template03JS.keyword = $('#keyword').val() || null;
        },
    }

    $(function () {

        // 검색어 검색
        $('#searchForm').on('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // 기본 동작(폼 제출) 막기
                template03JS.keyword = $('#keyword').val();
                template03JS.fnPage(1, false);
            }
        });
        $("#search-button").on('click', function (event) {
           event.preventDefault();
           template03JS.keyword = $('#keyword').val();
           template03JS.fnPage(1, false);
        });

    });

</script>
</html>
