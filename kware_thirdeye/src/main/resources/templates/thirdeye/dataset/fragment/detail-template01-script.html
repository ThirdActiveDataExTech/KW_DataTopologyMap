<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<script th:inline="javascript">

    var template01JS = {

        chartDom: null,
        chart: null,
        metDataFiles: [],

        drawTab01: function (dataset) {
            template01JS.drawSummaryDescription(dataset);   // 메인 상단 디테일 영역 구성
            template01JS.drawMetadataTab(dataset);          // tab1 구성 > 메타데이터 탭
            template01JS.setDataTable(dataset);             // tab1 구성 > json 테이블 영역
            template01JS.setSubTabSampleVisualization();    // tab2 구성
            template01JS.setMetaDataDownloadTab();          // tab3 구성
        },

        drawMetadataTab: function (dataset) {
            const metadataFile = dataset['mobigenDatasetView']?.['metadataFiles']?.[0]
            $("#metadata-badge").text(metadataFile['extension']);
            $("#metadata-desc").text(metadataFile['orgFileNm']);
        },

        drawSummaryDescription: async function (dataset) {

            const extraJson = JSON.parse(dataset['extraJson'])

            const newSummary = extraJson['summary'].replace(/\n/g, "<br>");
            $("#summary").html(newSummary);

            let editor = new Editor("description", extraJson['description'], false);
            editor = await editor.init(true);
        },

        setDataTable: function (dataset) {

            const jsonObj = JSON.parse(dataset?.['mobigenDatasetView']?.['metadata']);
            const $tableBody = $('#tab1-table tbody');
            $tableBody.empty(); // 기존 내용 제거
            const itemsPerRow = 2;

            /* jsonObj => key-value 배열로 변환 */
            function flattenObj(obj) {
                const result = [];
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        let value = obj[key];
                        if (Array.isArray(value)) {
                            value = value.join(', ');
                        } else if (typeof value === 'object' && value !== null) {
                            value = JSON.stringify(value); // 객체는 문자열로 변환
                        }
                        result.push({ key, value });
                    }
                }
                return result;
            }
            const entries = flattenObj(jsonObj);
            const totalItems = entries.length;
            const totalRows = Math.ceil(totalItems / itemsPerRow);
            for (let i = 0; i < totalRows; i++) {
                const row = $('<tr>');
                for (let j = 0; j < itemsPerRow; j++) {
                    const index = i * itemsPerRow + j;
                    if (index < totalItems) {
                        const item = entries[index];
                        row.append(`
                            <td class="col-2 width1">${item.key}</td>
                            <td class="col-4">${item.value}</td>
                        `);
                    }
                }
                $tableBody.append(row);
            }
        },

        setSubTabSampleVisualization : function(){
            const generateSampleData = (rows = 2, cols = 12, min = 1, max = 210) =>
                Array.from({ length: rows }, () =>
                    Array.from({ length: cols }, () =>
                        +(Math.random() * (max - min) + min).toFixed(2)
                    )
                );
            const sampleData = generateSampleData();
            template01JS.chartDom = new Chart("searchTrendTimeZoneBoard")
                                            .setData(sampleData)
                                            .setBarChart()
                                            .init();
            template01JS.chart = template01JS.chartDom._myChart;
            $(window).resize(function() { template01JS.chart.resize() });
        },

        setMetaDataDownloadTab: function () {

            const randomFileNum = Math.random() < 0.5 ? 1 : 2;                      // 1 혹은 2 랜덤 선택
            const filePath = `/testdata/dataset_real_file_${randomFileNum}.json`;   // 썸네일 이미지 랜덤 선택

            // JSON 데이터 읽기
            Http.getJson(filePath).then(data => {

                template01JS.metDataFiles = data

                // 3. files 길이에 따라 history-title 세팅
                const filesLength = data.files.length;
                const title = (filesLength === 1) ?  "신규데이터 (1건)" : `주기성 과거 데이터 ( ${filesLength}건 )`;
                $("#metadata-file-history-title").text(title);

                // 4. 테이블 body 구성
                const $tbody = $("#metadata-history-table-body");
                $tbody.empty(); // 초기화
                $.each(data.files, function(index, file) {
                    const $tr = $("<tr>").attr("data-id", file['datafileId'])
                        .append($("<td>").text(file['fileNm']))
                        .append($("<td>").text(file['regDt']));
                    $tbody.append($tr);
                });
            });
        },

        showMetDataFileInfoModal: function (datafileId) {

            console.log(">>> 클릭한 행 data-id:", datafileId);
            $("#metadata-file-info").empty();

            Http.getJson('/testdata/dataset_file_info.json').then(data => {
                const fileData = data.find(d => d['datafileId'] === datafileId);
                if (!fileData) {
                    Util.alert("데이터를 찾을 수 없습니다.");
                    return;
                }
                const infoList = [
                    { key: '데이터셋명', value: fileData['datasetNm'] },
                    { key: '데이터셋 유형', value: fileData['datasetType'] },
                    { key: '파일 유형', value: fileData['datafileType'] },
                    { key: '등록일', value: fileData['regDt'] },
                    { key: '생성자', value: fileData['creator'] },
                    { key: '연락처', value: fileData['contact'] },
                    { key: '설명', value: fileData['desc'] },
                    { key: '행 개수', value: fileData['rows'] },
                    { key: '열 개수', value: fileData['cols'] },
                    { key: '다운로드 유형', value: fileData['downloadType'] },
                    { key: '수정이력', value: fileData['updateHistory'] },
                    { key: '라이선스', value: fileData['license'] },
                ];

                let tableHtml = `<table style="width:100%; border-collapse: collapse;">`;
                tableHtml += `<tr>
                                <th>컬럼</th><th>값</th>
                                <th>컬럼</th><th>값</th>
                              </tr>`;
                for ( let i = 0; i < infoList.length; i+=2 ) {
                    const first = infoList[i]
                    const second = infoList[i+1]
                    tableHtml += `<tr><td>${first.key}</td><td>${first.value}</td>`;
                    if(second) tableHtml += `<td>${second.key}</td><td>${second.value}</td>`;
                    else tableHtml += `<td></td><td></td>`;
                    tableHtml += `</tr>`;
                }
                tableHtml += `</table>`;
                $("#metadata-file-info").html(tableHtml);
                $("#metaDataFileInfoModal").modal('show');
            });

        }

    }

    $(function () {

        $("#file-download").on("click", function (e) {
            console.log("file download")
        });

        $("#metadata-download-btn").on('click', async function (e) {
            const metadataFile = dataset['mobigenDatasetView']?.['metadataFiles']?.[0]
            await FileUtil.fileDownload(metadataFile?.['fileId'])
        });

        $(document).on('click', `.history-table tbody tr`, function () {
            const id = $(this).data("id");
            template01JS.showMetDataFileInfoModal(id);
        });

        $("#close-btn").on('click', function () {
           $("#metaDataFileInfoModal").modal('hide');
        });
    });

</script>
</html>
