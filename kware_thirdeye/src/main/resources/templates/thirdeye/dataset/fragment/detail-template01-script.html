<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<script th:inline="javascript">

    /** 모달 닫을때 생기는 warning 해결 **/
    $(document).on('hide.bs.modal', function () {
        if (document.activeElement) {
            $(document.activeElement).blur();
        }
    });

    var template01JS = {

        chartDom: null,
        chart: null,
        metDataFiles: [],

        drawTab01: function (dataset) {
            const extraJson = JSON.parse(dataset['extraJson'])
            template01JS.drawSummaryDescription(extraJson);   // 메인 상단 디테일 영역 구성 + 추가 정보
            template01JS.drawMetadataTab(dataset);            // tab1 > 메타데이터 탭
            template01JS.drawExtraMetadata(dataset);          // tab1 > 추가 메타데이터 탭
            template01JS.setDataTable(extraJson);             // tab1 > json 테이블 영역
        },

        drawMetadataTab: async function (dataset) {

            if(!dataset['metadataView']?.['packagedataFile']) {
                $("#downloadPackage").prop('disabled', true).prop('readonly', true)
            }

            /* ========= 1. 메타데이터 정보 =========*/
            const metadataFile = dataset['metadataView']?.['metadataFile'] || dataset['metadataView']?.['packagedataFile']
            if(metadataFile){
                $("#metadata-file-id").val(metadataFile['fileId']);
                $("#metadata-id").val(metadataFile['metadataId']);
                $("#metadata-badge").text(metadataFile['extension']);
                $("#metadata-desc").text(metadataFile['orgFileNm']);
            }

            /* ========= 2. 실(원본)데이터 정보 =========*/

            const rawdataFiles = dataset['metadataView']?.['rawdataFiles'] || []
            if (rawdataFiles.length !== 0) {
                const filesLength = rawdataFiles.length;
                const title = (filesLength === 1) ? "신규데이터 (1건)" : `주기성 과거 데이터 ( ${filesLength}건 )`;
                $("#metadata-file-history-title").text(title);
                const $tbody = $("#metadata-history-table-body");
                $tbody.empty(); // 초기화

                rawdataFiles.forEach((data) => {
                    const $tr = $("<tr>")
                        .attr("data-meta", data['metadataId'])
                        .attr("data-raw", data['rawdataId'])
                        .append($("<td>").text(data['orgFileNm']))
                        .append($("<td>").text(data['regDt']));
                    $tbody.append($tr);
                });
            } else {
                const $historyBox = $("#history-box")
                $historyBox.empty();
                $historyBox.append(`<span>정보가 없습니다.</span>`)
            }
        },

        drawExtraMetadata: function (dataset) {
            const metadataStr = dataset?.['metadataView']?.['extdata'] || "{}"
            const metadataObj = JSON.parse(metadataStr)

            const container = document.getElementById("jsoneditor");
            const options = {
                mode: "view",  // view 모드로 읽기 전용
                onError: function (err) {
                    console.error('err: ', err)
                },
                onModeChange: function (newMode, oldMode) { }
            };
            const editor = new JSONEditor(container, options);
            editor.set(metadataObj);
        },

        drawSummaryDescription: async function (extraJson) {
            const newSummary = extraJson['summary'].replace(/\n/g, "<br>");
            const summary = (newSummary.length !== 0) ? newSummary : '해당 데이터에 대해 요약 정보가 없습니다.'
            $("#summary").html(summary);

            const description = (extraJson['description'].length !== 0) ? extraJson['description'] : `<p>해당 데이터에 대해 추가 정보가 없습니다.</p>`
            let editor = new Editor("description", description, false);
            editor = await editor.init(true);
        },

        setDataTable: function (extraJson) {
            const addInfo = extraJson?.['addInfo'] || [];
            const $tableBody = $('#tab1-table-tbody');
            $tableBody.empty(); // 기존 내용 제거

            if(addInfo.length === 0) {
                $tableBody.append(`<tr class="text-center"><td colSpan="2" class="text-center py-2">정보가 없습니다.</td></tr>`)
            } else {
                const itemsPerRow = 2
                const totalItems = addInfo.length;
                const totalRows = Math.ceil(totalItems / itemsPerRow);
                for (let i = 0; i < totalRows; i++) {
                    const row = $('<tr>');
                    for (let j = 0; j < itemsPerRow; j++) {
                        const index = i * itemsPerRow + j;
                        if (index < totalItems) {
                            const item = addInfo[index];
                            row.append(`
                                <td class="col-2 width1">${item.label}</td>
                                <td class="col-4">${item.value}</td>
                            `);
                        }
                    }
                    $tableBody.append(row);
                }
            }
        },

        showMetDataFileInfoModal: async function (metaId, rawId) {

            $("#metadata-file-info").empty();
            const obj = { metadataId: metaId, rawdataId: rawId }
            Http.post(`/api/portal/integration-dataset/view-rawdata`, obj, true).then((res) => {
                if (!res) {
                    Util.alert("데이터를 찾을 수 없습니다.");
                    return;
                }
                const infoList = [
                    { key: '원본데이터 파일Id', value: res['rawdataFile']['fileId'] },
                    { key: '원본데이터 파일경로', value: res['rawdataFile']['filePath'] },
                    { key: '원본데이터 파일크기', value: res['rawdataFile']['fileSize'] },
                    { key: '원본데이터 파일유형', value: res['rawdataFile']['fileType'] },
                    { key: '원본데이터 파일이름', value: res['rawdataFile']['orgFileNm'] },
                    { key: '원본데이터 다운로드횟수', value: res['rawdataFile']['downCnt'] },
                    { key: '원본데이터 파일 등록일', value: res['rawdataFile']['regDt'] },
                    { key: '원본데이터 파일 수정일', value: res['rawdataFile']['regDt'] }
                ]
                let tableHtml = `<table style="width:100%; border-collapse: collapse; border: 1px solid #ccc;">`;
                for (let i = 0; i < infoList.length; i += 2) {
                    const first = infoList[i];
                    const second = infoList[i + 1];
                    tableHtml += `<tr>
                                    <td style="background-color: #2b292a24;">${first.key}</td>
                                    <td style="vertical-align: middle;">${first.value}</td>`;
                    if (second) tableHtml += `<td style="background-color: #2b292a24;">${second.key}</td>
                                              <td style="vertical-align: middle;">${second.value}</td>`;
                    else tableHtml += `<td></td><td></td>`; // 홀수 개일 때 빈 칸
                    tableHtml += `</tr>`;
                }
                tableHtml += `<tr>
                                  <td style="background-color: #2b292a24;">원본데이터 파일 다운로드</td>
                                  <td style="vertical-align: middle;">
                                    <button class="custom-button realdata-file-download"
                                    data-file="${res['rawdataFile']['fileId']}"
                                    data-meta="${res['metadataId']}"
                                    data-raw="${res['rawdataId']}">
                                      <i class="ti-cloud-down"></i> 다운로드
                                    </button>
                                  </td>
                              </tr>
`
                tableHtml += `</table>`;
                $("#metadata-file-info").html(tableHtml);
                $("#metaDataFileInfoModal").modal('show');
            });
        },

        packageDownloadBtnClickEvent: async function (metadataId, rawdataIds = []) {
            // todo[mobigen] download package
            const obj = { metadataId: metadataId, rawdataIds: rawdataIds }
            const res = await Http.post('/api/portal/integration-dataset/download-package', obj, true)
            console.log(">> res : ", res);
        }
    }

    $(function () {

        $("#metadata-download-btn").on('click', async function (e) {
            const metadataFileId = $("#metadata-file-id").val();
            const metadataId = $("#metadata-id").val()
            const response = await Http.get(`/api/portal/dataset-file/check-file`, {"fileId": metadataFileId})
            if (!response) Util.alert("해당 경로에 파일이 없습니다.")
            else {
                const obj = {metadataId, metadataFileId}
                const query = new URLSearchParams(obj).toString();
                window.location.href = `/api/portal/integration-dataset/download-metadata?${query}`
            }
        });

        $(document).on('click', `.history-table tbody tr`, function () {
            const metaId = $(this).data("meta");
            const rawId = $(this).data("raw");
            template01JS.showMetDataFileInfoModal(metaId, rawId);
        });

        $(document).on('click', '.realdata-file-download', async function () {
            const rawdataFileId = $(this).data('file');
            const rawdataId = $(this).data('raw');
            const metadataId = $(this).data('meta');

            const response = await Http.get(`/api/portal/dataset-file/check-file`, {"fileId": rawdataFileId})
            if (!response) Util.alert("해당 경로에 파일이 없습니다.")
            else {
                const obj = { metadataId, rawdataId, rawdataFileId }
                const query = new URLSearchParams(obj).toString();
                window.location.href = `/api/portal/integration-dataset/download-rawdata?${query}`
            }
        })

        $("#close-btn").on('click', function () {
           $("#metaDataFileInfoModal").modal('hide');
        });
    });

</script>
</html>
