<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<script th:inline="javascript">

    var template01JS = {

        metDataFiles: [],

        drawTab01: function (dataset) {
            template01JS.setDataTable(dataset);             // tab1 구성
            template01JS.setSubTabSampleVisualization();    // tab2 구성
            template01JS.setMetaDataDownloadTab();          // tab3 구성
        },

        setDataTable: function (dataset) {

            const jsonObj = JSON.parse(dataset['metadata']);
            const $tableBody = $('#tab1-table tbody');
            $tableBody.empty(); // 기존 내용 제거
            const itemsPerRow = 2;

            /* jsonObj => key-value 배열로 변환 */
            function flattenObj(obj) {
                const result = [];
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        let value = obj[key];
                        if (Array.isArray(value)) {
                            value = value.join(', ');
                        } else if (typeof value === 'object' && value !== null) {
                            value = JSON.stringify(value); // 객체는 문자열로 변환
                        }
                        result.push({ key, value });
                    }
                }
                return result;
            }
            const entries = flattenObj(jsonObj);
            const totalItems = entries.length;
            const totalRows = Math.ceil(totalItems / itemsPerRow);
            for (let i = 0; i < totalRows; i++) {
                const row = $('<tr>');
                for (let j = 0; j < itemsPerRow; j++) {
                    const index = i * itemsPerRow + j;
                    if (index < totalItems) {
                        const item = entries[index];
                        row.append(`
                            <td class="col-2 width1">${item.key}</td>
                            <td class="col-4">${item.value}</td>
                        `);
                    }
                }
                $tableBody.append(row);
            }
        },

        setSubTabSampleVisualization : function(){
            const sampleData = {
                "dataList1" : [170.07, 164.74, 120.1, 105.83, 23.14, 24.84, 198.2, 85.34, 62.52, 114.19, 116.91, 75.84],
                "dataList2" : [1.44, 97.92, 79.27, 105.65, 168.2, 108.48, 126.39, 130.05, 205.69, 179.64, 119.06, 155.43]
            }
            const obj = {
                renderID : $("#searchTrendTimeZoneBoard").get(0),
                color1 : "#596fc0",
                color2 : "#9eca7f",
                dataList1 : sampleData.dataList1,
                dataList2 : sampleData.dataList2
            }
            template01JS.setEchartBar(obj);
        },

        setEchartBar : function (argObj){
            const option = {
                tooltip: {},
                xAxis: {
                    data: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    //name: 'Month',
                    axisLabel: {
                        interval: 0,
                        fontSize: 8
                    },
                    axisLine: { onZero: true },
                    splitLine: { show: false },
                    splitArea: { show: false }
                },
                yAxis: {
                    name: 'Data',
                    axisLabel: {
                        fontSize: 8
                    },
                    axisLine: { onZero: true },
                    splitLine: { show: true },
                    splitArea: { show: false }
                },
                grid: {
                    left: 30,
                    right: 30,
                    top: 40,
                    bottom: 70
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: '100%'
                    },
                    {
                        start: 0,
                        end: 20,
                        bottom: '5px'
                    }
                ],
                series: [
                    {
                        name: 'bar',
                        type: 'bar',
                        stack: 'one',
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: argObj.color1
                            }
                        },
                        data: argObj.dataList1
                    },
                    {
                        name: 'bar2',
                        type: 'bar',
                        stack: 'two',
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: argObj.color2
                            }
                        },
                        data: argObj.dataList2
                    }
                ]
            };
            template01JS.setDataToEchart(argObj.renderID, option);
        },

        setDataToEchart : function(renderId, option){
            let myChart = echarts.init(renderId);
            myChart.hideLoading();
            option && myChart.setOption(option);

            $(window).resize(function() {
                myChart.resize();
            });
        },

        setMetaDataDownloadTab: function () {

            // 1 혹은 2 랜덤 선택
            const randomFileNum = Math.random() < 0.5 ? 1 : 2;
            const filePath = `/testdata/dataset_real_file_${randomFileNum}.json`;

            // JSON 데이터 읽기
            Http.getJson(filePath).then(data => {

                template01JS.metDataFiles = data

                // 1. extension 세팅
                $("#metadata-badge").text(data.extension);

                // 2. title 세팅
                $("#metadata-desc").text(data.title);

                // 3. files 길이에 따라 history-title 세팅
                const filesLength = data.files.length;
                const title = (filesLength === 1) ?  "신규데이터 (1건)" : `주기성 과거 데이터 ( ${filesLength}건 )`;
                $("#metadata-file-history-title").text(title);

                // 4. 테이블 body 구성
                const $tbody = $("#metadata-history-table-body");
                $tbody.empty(); // 초기화
                $.each(data.files, function(index, file) {
                    const $tr = $("<tr>").attr("data-id", file['datafileId'])
                        .append($("<td>").text(file['fileNm']))
                        .append($("<td>").text(file['regDt']));
                    $tbody.append($tr);
                });
            });
        },

        showMetDataFileInfoModal: function (datafileId) {

            console.log(">>> 클릭한 행 data-id:", datafileId);
            $("#metadata-file-info").empty();

            Http.getJson('/testdata/dataset_file_info.json').then(data => {
                const fileData = data.find(d => d['datafileId'] === datafileId);
                if (!fileData) {
                    Util.alert("데이터를 찾을 수 없습니다.");
                    return;
                }

                const infoList = [
                    { key: '데이터셋명', value: fileData['datasetNm'] },
                    { key: '데이터셋 유형', value: fileData['datasetType'] },
                    { key: '파일 유형', value: fileData['datafileType'] },
                    { key: '등록일', value: fileData['regDt'] },
                    { key: '생성자', value: fileData['creator'] },
                    { key: '연락처', value: fileData['contact'] },
                    { key: '설명', value: fileData['desc'] },
                    { key: '행 개수', value: fileData['rows'] },
                    { key: '열 개수', value: fileData['cols'] },
                    { key: '다운로드 유형', value: fileData['downloadType'] },
                    { key: '수정이력', value: fileData['updateHistory'] },
                    { key: '라이선스', value: fileData['license'] },
                ];

                let tableHtml = `<table style="width:100%; border-collapse: collapse;">`;
                tableHtml += `<tr>
                                <th>컬럼</th><th>값</th>
                                <th>컬럼</th><th>값</th>
                              </tr>`;

                for ( let i = 0; i < infoList.length; i+=2 ) {
                    const first = infoList[i]
                    const second = infoList[i+1]
                    tableHtml += `<tr><td>${first.key}</td><td>${first.value}</td>`;
                    if(second) tableHtml += `<td>${second.key}</td><td>${second.value}</td>`;
                    else tableHtml += `<td></td><td></td>`;
                    tableHtml += `</tr>`;
                }
                tableHtml += `</table>`;
                $("#metadata-file-info").html(tableHtml);
                $("#metaDataFileInfoModal").modal('show');
            });

        }

    }

    $(function () {

        $("#file-download").on("click", function (e) {
            console.log("file download")
        });

        $("#metadata-download-btn").on('click', function (e) {
           console.log("메타데이터 탭 > 데이터 다운로드 버튼 클릭..");
        });

        $(document).on('click', `.history-table tbody tr`, function () {
            const id = $(this).data("id");
            template01JS.showMetDataFileInfoModal(id);
        });

        $("#close-btn").on('click', function () {
           $("#metaDataFileInfoModal").modal('hide');
        });
    });

</script>
</html>
