<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<script th:inline="javascript">

    var template01JS = {

        chartDom: null,
        chart: null,
        metDataFiles: [],

        drawTab01: function (dataset) {
            const extraJson = JSON.parse(dataset['extraJson'])
            template01JS.drawSummaryDescription(extraJson);   // 메인 상단 디테일 영역 구성 + 추가 정보
            template01JS.drawMetadataTab(dataset);            // tab1 > 메타데이터 탭
            template01JS.drawExtraMetadata(dataset);          // tab1 > 추가 메타데이터 탭
            template01JS.setDataTable(extraJson);             // tab1 > json 테이블 영역
            /*template01JS.setSubTabSampleVisualization();    // tab1 > 차트탭*/
        },

        drawMetadataTab: async function (dataset) {

            if(!dataset['mobigenDatasetView']?.['packagedataFile']) {
                console.log("its null")
                $("#downloadPackage").prop('disabled', true).prop('readonly', true)
            }

            /* ========= 1. 메타데이터 정보 =========*/
            const metadataFile = dataset['mobigenDatasetView']?.['metadataFile'] || dataset['mobigenDatasetView']?.['packagedataFile']
            if(metadataFile){
                $("#metadata-id").val(metadataFile['fileId']);
                $("#metadata-badge").text(metadataFile['extension']);
                $("#metadata-desc").text(metadataFile['orgFileNm']);
            }

            /* ========= 2. 실(원본)데이터 정보 =========*/
            // todo[mobigen] list of realdata
            const mobigen_obj = {
                metadata_id: dataset['datasetId'],
                pagination: { page: 1, limit: 10 }
            }
            const res = await Http.post('/api/portal/mobigen-dataset2/rawdata01', mobigen_obj, true)
            console.log(">> res : ", res)

            const rawdataFiles = dataset['mobigenDatasetView']?.['rawdataFiles'] || []
            if (rawdataFiles.length !== 0) {
                const filesLength = rawdataFiles.length;
                const title = (filesLength === 1) ? "신규데이터 (1건)" : `주기성 과거 데이터 ( ${filesLength}건 )`;
                $("#metadata-file-history-title").text(title);
                const $tbody = $("#metadata-history-table-body");
                $tbody.empty(); // 초기화

                rawdataFiles.forEach((data) => {
                    const $tr = $("<tr>")
                        .attr("data-meta", data['metadataId'])
                        .attr("data-raw", data['rawdataId'])
                        .append($("<td>").text(data['orgFileNm']))
                        .append($("<td>").text(data['regDt']));
                    $tbody.append($tr);
                });
            } else {
                const $historyBox = $("#history-box")
                $historyBox.empty();
                $historyBox.append(`<span>정보가 없습니다.</span>`)
            }
        },

        drawExtraMetadata: function (dataset) {
            const metadataStr = dataset?.['mobigenDatasetView']?.['metadata'] || "{}"
            const metadataObj = JSON.parse(metadataStr)

            const container = document.getElementById("jsoneditor");
            const options = {
                mode: "view",  // view 모드로 읽기 전용
                onError: function (err) {
                    console.error('err: ', err)
                },
                onModeChange: function (newMode, oldMode) {
                    //console.log("Mode changed from", oldMode, "to", newMode);
                }
            };
            const editor = new JSONEditor(container, options);
            editor.set(metadataObj);
        },

        drawSummaryDescription: async function (extraJson) {
            const newSummary = extraJson['summary'].replace(/\n/g, "<br>");
            const summary = (newSummary.length !== 0) ? newSummary : '해당 데이터에 대해 요약 정보가 없습니다.'
            $("#summary").html(summary);

            const description = (extraJson['description'].length !== 0) ? extraJson['description'] : `<p>해당 데이터에 대해 추가 정보가 없습니다.</p>`
            let editor = new Editor("description", description, false);
            editor = await editor.init(true);
        },

        setDataTable: function (extraJson) {
            const addInfo = extraJson?.['addInfo'] || [];
            const $tableBody = $('#tab1-table-tbody');
            $tableBody.empty(); // 기존 내용 제거

            if(addInfo.length === 0) {
                $tableBody.append(`<tr class="text-center"><td colSpan="2" class="text-center py-2">정보가 없습니다.</td></tr>`)
                $("#downloadPackage").prop('disabled', true).prop('readonly', true)
            }
            else {
                const itemsPerRow = 2
                const totalItems = addInfo.length;
                const totalRows = Math.ceil(totalItems / itemsPerRow);
                for (let i = 0; i < totalRows; i++) {
                    const row = $('<tr>');
                    for (let j = 0; j < itemsPerRow; j++) {
                        const index = i * itemsPerRow + j;
                        if (index < totalItems) {
                            const item = addInfo[index];
                            row.append(`
                            <td class="col-2 width1">${item.label}</td>
                            <td class="col-4">${item.value}</td>
                        `);
                        }
                    }
                    $tableBody.append(row);
                }
            }
        },

        showMetDataFileInfoModal: async function (metaId, rawId) {

            // [todo] mobigen rawdata view
            const mobigen_obj = {metadata_id: metaId, rawdata_id: rawId}
            const res = await Http.post(`/api/portal/mobigen-dataset2/rawdata04`, mobigen_obj, true)
            console.log(">> res : ", res)


            $("#metadata-file-info").empty();
            const obj = { metadataId: metaId, rawdataId: rawId }
            Http.get(`/api/portal/dataset-file/rawdata-file-view`, obj).then((res) => {
                if (!res) {
                    Util.alert("데이터를 찾을 수 없습니다.");
                    return;
                }
                const infoList = [
                    { key: '실데이터 파일Id', value: res['fileId'] },
                    { key: '실데이터 파일경로', value: res['filePath'] },
                    { key: '실데이터 파일크기', value: res['fileSize'] },
                    { key: '실데이터 파일유형', value: res['fileType'] },
                    { key: '실데이터 파일이름', value: res['orgFileNm'] },
                    { key: '실데이터 다운로드횟수', value: res['downCnt'] },
                    { key: '실데이터 파일 등록일', value: res['regDt'] },
                    { key: '실데이터 파일 수정일', value: res['regDt'] }
                ]
                let tableHtml = `<table style="width:100%; border-collapse: collapse; border: 1px solid #ccc;">`;
                for (let i = 0; i < infoList.length; i += 2) {
                    const first = infoList[i];
                    const second = infoList[i + 1];
                    tableHtml += `<tr>
                                    <td style="background-color: #2b292a24;">${first.key}</td>
                                    <td style="vertical-align: middle;">${first.value}</td>`;
                    if (second) tableHtml += `<td style="background-color: #2b292a24;">${second.key}</td>
                                              <td style="vertical-align: middle;">${second.value}</td>`;
                    else tableHtml += `<td></td><td></td>`; // 홀수 개일 때 빈 칸
                    tableHtml += `</tr>`;
                }
                tableHtml += `<tr>
                                  <td style="background-color: #2b292a24;">실데이터 파일 다운로드</td>
                                  <td style="vertical-align: middle;">
                                    <button class="custom-button realdata-file-download" data-id="${res['fileId']}">
                                      <i class="ti-cloud-down"></i> 다운로드
                                    </button>
                                  </td>
                              </tr>
`
                tableHtml += `</table>`;
                $("#metadata-file-info").html(tableHtml);
                $("#metaDataFileInfoModal").modal('show');
            });
        },

        packageDownloadBtnClickEvent: async function (datasetId, rawdataIds = []) {
            // todo[mobigen] download package
            const obj = { metadataId: datasetId, rawdataIds: rawdataIds }
            const res = await Http.post('/api/portal/mobigen-dataset2/package01', obj, true)
            console.log(">> res : ", res);
        }

        /*setSubTabSampleVisualization : function(){
            const generateSampleData = (rows = 2, cols = 12, min = 1, max = 210) =>
                Array.from({ length: rows }, () =>
                    Array.from({ length: cols }, () =>
                        +(Math.random() * (max - min) + min).toFixed(2)
                    )
                );
            const sampleData = generateSampleData();
            template01JS.chartDom = new Chart("searchTrendTimeZoneBoard")
                                            .setData(sampleData)
                                            .setBarChart()
                                            .init();
            template01JS.chart = template01JS.chartDom._myChart;
            $(window).resize(function() { template01JS.chart.resize() });
        },*/
    }

    $(function () {

        $("#metadata-download-btn").on('click', async function (e) {

            const metadataFileId = $("#metadata-id").val();

            // [todo] mobigen metadata file download
            const mobigen_obj = { metadata_id: metadataFileId }
            const res = await Http.post('/api/portal/mobigen-dataset2/metadata08', mobigen_obj, true)
            console.log(">>> res : ", res)

            await DataFileUtil.fileDownload(metadataFileId)
        });

        $(document).on('click', `.history-table tbody tr`, function () {
            const metaId = $(this).data("meta");
            const rawId = $(this).data("raw");
            template01JS.showMetDataFileInfoModal(metaId, rawId);
        });

        $(document).on('click', '.realdata-file-download', async function () {
            const fileId = $(this).data('id');

            // [todo] mobigen rawdata file download
            const mobigen_obj = { metadata_id: 1, rawdata_id: fileId }
            const res = await Http.post(`/api/portal/mobigen-dataset2/rawdata07`, mobigen_obj, true)
            console.log(">> res : ", res)

            await DataFileUtil.fileDownload(fileId)
        })

        $("#close-btn").on('click', function () {
           $("#metaDataFileInfoModal").modal('hide');
        });
    });

</script>
</html>
