<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">

<th:block layout:fragment="center-image">
    <th:block th:with="title1='차트', title2='', leftImg='', rightImg=''">
        <th:block th:replace="fragments/center-image :: center-image-title-custom(${title}, ${title1}, ${title2}, ${leftImg}, ${rightImg})"></th:block>
    </th:block>
</th:block>

<th:block layout:fragment="head">
    <link rel="stylesheet" th:href="@{'/assets/css/page/list.css'}" />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
    <style>
        .filter-bar {
            margin-bottom: 10px;
        }
    </style>
</th:block>

<th:block layout:fragment="content">
    <div class="my-account-wrapper pb-100 pt-30">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="text-end mb-2">
                        <div class="filter-bar">
<!--                            <label><input type="checkbox" value="person" checked onchange="updateFilter()"> 출연진</label>-->
<!--                            <label><input type="checkbox" value="content" checked onchange="updateFilter()"> 작품</label>-->
                        </div>
                        <button id="reset-btn" style="display: none;" class="btn btn-sm btn-outline-secondary">처음으로</button>
                    </div>
                    <div id="mindmap-chart" style="width: 100%; height: 600px;"></div>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        const chartDom = document.getElementById('mindmap-chart');
        const myChart = echarts.init(chartDom);
        const resetBtn = document.getElementById('reset-btn');

        // 이전 루트 스택
        const prevStack = [];

        // 트리 데이터 정의
        const treeDB = {
            "지옥에서 온 판사": {
                type: "content",
                people: ["박신혜"]
            },
            "박신혜": {
                type: "person",
                groups: {
                    "드라마": ["장근석", "이규한", "김재영", "이민호"],
                    "예능": ["유재석", "유연석"]
                }
            },
            "장근석": {
                type: "person",
                groups: {
                    "드라마": ["스위치", "대박", "미남이시네요"]
                }
            },
            "미남이시네요": {
                type: "content",
                people: ["장근석", "이홍기", "정용화"]
            },
            "스위치": { type: "content", people: [] },
            "대박": { type: "content", people: [] },
            "이규한": { type: "person", groups: {} },
            "김재영": { type: "person", groups: {} },
            "이민호": { type: "person", groups: {} },
            "유재석": { type: "person", groups: {} },
            "유연석": { type: "person", groups: {} },
            "이홍기": { type: "person", groups: {} },
            "정용화": { type: "person", groups: {} }
        };

        let currentRoot = "지옥에서 온 판사";

        // "이전으로" 버튼 생성
        const backBtn = document.createElement("button");
        backBtn.className = "btn btn-sm btn-outline-secondary me-1";
        backBtn.id = "back-btn";
        backBtn.style.display = "none";
        backBtn.innerText = "이전으로";
        resetBtn.parentNode.insertBefore(backBtn, resetBtn);

        backBtn.addEventListener("click", () => {
            if (prevStack.length > 0) {
                currentRoot = prevStack.pop();
                renderTree(currentRoot);
            }
        });

        function getTreeData(rootName) {
            const node = treeDB[rootName];
            if (!node) return { name: rootName };

            const root = { name: rootName, children: [] };

            if (node.type === "content") {
                (node.people || []).forEach(person => {
                    root.children.push({
                        name: person,
                        children: makeGroupNodes(person)
                    });
                });
            } else if (node.type === "person") {
                root.children = makeGroupNodes(rootName);
            }

            return root;
        }

        function makeGroupNodes(personName) {
            const person = treeDB[personName];
            const result = [];
            if (!person || !person.groups) return result;

            Object.entries(person.groups).forEach(([groupName, targets]) => {
                result.push({
                    name: groupName,
                    children: targets.map(t => ({ name: t }))
                });
            });

            return result;
        }

        function hasChildren(name) {
            const node = treeDB[name];
            if (!node) return false;

            if (node.type === "content") {
                return node.people && node.people.length > 0;
            } else if (node.type === "person") {
                return node.groups && Object.keys(node.groups).length > 0;
            }

            return false;
        }

        function renderTree(rootName) {
            const treeData = getTreeData(rootName);

            myChart.clear();
            myChart.setOption({
                tooltip: { trigger: 'item', triggerOn: 'mousemove' },
                series: [
                    {
                        type: 'tree',
                        data: [treeData],
                        top: '5%',
                        left: '10%',
                        bottom: '5%',
                        right: '10%',
                        orient: 'TB',
                        symbolSize: 30,
                        edgeForkPosition: '50%',
                        label: {
                            position: 'top',
                            verticalAlign: 'middle',
                            align: 'center',
                            fontSize: 14
                        },
                        leaves: {
                            label: {
                                position: 'bottom',
                                verticalAlign: 'middle',
                                align: 'center',
                                fontSize: 12
                            }
                        },
                        lineStyle: {
                            width: 1,
                            curveness: 0.5
                        },
                        expandAndCollapse: true,
                        initialTreeDepth: 2,
                        animationDuration: 300,
                        animationDurationUpdate: 500
                    }
                ]
            });

            myChart.off('click');
            myChart.on('click', function (params) {
                const name = params.data.name;
                const type = treeDB[name]?.type;

                // 노드가 person/content 이고 하위 노드가 있을 때만 클릭 처리
                if ((type === "person" || type === "content") && hasChildren(name)) {
                    prevStack.push(currentRoot);
                    currentRoot = name;
                    renderTree(currentRoot);
                }
            });

            resetBtn.style.display = currentRoot === "지옥에서 온 판사" ? "none" : "inline-block";
            backBtn.style.display = prevStack.length > 0 ? "inline-block" : "none";
        }

        resetBtn.addEventListener('click', () => {
            currentRoot = "지옥에서 온 판사";
            prevStack.length = 0;
            renderTree(currentRoot);
        });

        renderTree(currentRoot);
    </script>
</th:block>
</html>
</html>