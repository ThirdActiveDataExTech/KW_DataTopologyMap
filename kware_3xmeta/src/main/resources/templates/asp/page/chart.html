<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">

<th:block layout:fragment="center-image">
    <th:block th:with="title1='차트', title2='', leftImg='', rightImg=''">
        <th:block th:replace="fragments/center-image :: center-image-title-custom(${title}, ${title1}, ${title2}, ${leftImg}, ${rightImg})"></th:block>
    </th:block>
</th:block>

<th:block layout:fragment="head">
    <link rel="stylesheet" th:href="@{'/assets/css/page/list.css'}" />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
    <style>

    </style>
</th:block>

<th:block layout:fragment="content">
    <div class="my-account-wrapper pb-100 pt-30">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="text-end mb-2">
                        <button id="reset-btn" style="display: none;" class="btn btn-sm btn-outline-secondary">
                            처음으로
                        </button>
                    </div>
                    <div id="mindmap-chart" style="width: 100%; height: 600px;"></div>
                </div>
            </div>
        </div>
    </div>
</th:block>


<th:block layout:fragment="script">
    <script th:inline="javascript">
        const chartDom = document.getElementById('mindmap-chart');
        const myChart = echarts.init(chartDom);
        const resetBtn = document.getElementById('reset-btn');

        const graphDB = {
            "지옥에서 온 판사": {
                type: "content",
                edges: [
                    { target: "출연진" },
                    { target: "카테고리" },
                    { target: "언어" },
                    { target: "제작" }
                ]
            },
            "출연진": {
                type: "group",
                edges: [
                    { target: "박신혜" },
                    { target: "장근석" }
                ]
            },
            "카테고리": {
                type: "group",
                edges: [
                    { target: "드라마" }
                ]
            },
            "언어": {
                type: "group",
                edges: [
                    { target: "한국어" }
                ]
            },
            "제작": {
                type: "group",
                edges: [
                    { target: "SBS" }
                ]
            },
            "박신혜": {
                type: "person",
                edges: []
            },
            "장근석": {
                type: "person",
                edges: [
                    { target: "스위치" },
                    { target: "대박" },
                    { target: "미남이시네요" }
                ]
            },
            "스위치": {
                type: "content",
                edges: []
            },
            "대박": {
                type: "content",
                edges: []
            },
            "미남이시네요": {
                type: "content",
                edges: [] //  초기엔 비워두기
            },
            "이홍기": {
                type: "person",
                edges: []
            },
            "정용화": {
                type: "person",
                edges: []
            },
            "드라마": {
                type: "category",
                edges: []
            },
            "한국어": {
                type: "language",
                edges: []
            },
            "SBS": {
                type: "broadcaster",
                edges: []
            }
        };

        const typeCategoryMap = {
            content: 0,
            group: 1,
            person: 2,
            broadcaster: 3,
            category: 4,
            language: 5,
            default: 6
        };

        function renderGraph(rootName) {
            //미남이시네요일 때만 속성 연결 주입
            if (rootName === "미남이시네요") {
                graphDB["미남이시네요"].edges = [
                    { target: "출연진" },
                    { target: "카테고리" },
                    { target: "언어" },
                    { target: "제작" }
                ];
                graphDB["출연진"] = {
                    type: "group",
                    edges: [
                        { target: "장근석" },
                        { target: "이홍기" },
                        { target: "정용화" }
                    ]
                };
                graphDB["카테고리"] = {
                    type: "group",
                    edges: [{ target: "드라마" }]
                };
                graphDB["언어"] = {
                    type: "group",
                    edges: [{ target: "한국어" }]
                };
                graphDB["제작"] = {
                    type: "group",
                    edges: [{ target: "SBS" }]
                };
            } else {
                // 다른 노드로 갈 경우 미남이시네요 연결 제거
                graphDB["미남이시네요"].edges = [];
            }

            const nodes = [];
            const links = [];
            const visited = new Set();

            function dfs(nodeName) {
                if (visited.has(nodeName)) return;
                visited.add(nodeName);

                const node = graphDB[nodeName];
                const type = node?.type ?? "default";

                nodes.push({
                    name: nodeName,
                    category: typeCategoryMap[type],
                    symbolSize: nodeName === rootName ? 50 : 30
                });

                (node?.edges || []).forEach(edge => {
                    links.push({ source: nodeName, target: edge.target });
                    dfs(edge.target);
                });
            }

            dfs(rootName);
            drawGraph(nodes, links);
            resetBtn.style.display = rootName === "지옥에서 온 판사" ? "none" : "inline-block";
        }

        function drawGraph(nodes, links) {
            myChart.clear();
            myChart.setOption({
                tooltip: { show: true },
                series: [{
                    type: 'graph',
                    layout: 'force',
                    roam: true,
                    force: {
                        repulsion: 200,
                        edgeLength: 100
                    },
                    data: nodes,
                    links: links,
                    categories: [
                        { name: "작품" },
                        { name: "속성그룹" },
                        { name: "출연자" },
                        { name: "방송사" },
                        { name: "카테고리" },
                        { name: "언어" },
                        { name: "기타" }
                    ],
                    label: {
                        show: true,
                        position: 'right'
                    },
                    lineStyle: {
                        color: 'source',
                        curveness: 0.3
                    }
                }]
            });

            myChart.off('click');
            myChart.on('click', function (params) {
                const clicked = params.data.name;
                const clickedType = graphDB[clicked]?.type;
                if (!graphDB[clicked] || (clickedType !== 'content' && clickedType !== 'person')) return;
                renderGraph(clicked);
            });
        }

        resetBtn.addEventListener('click', () => {
            renderGraph("지옥에서 온 판사");
        });

        renderGraph("지옥에서 온 판사");
    </script>
</th:block>
</html>